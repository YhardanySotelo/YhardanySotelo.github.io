<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>iPod Classic - Rueda funcional + scroll + Juegos</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:#8d8d8d;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#fff;-webkit-font-smoothing:antialiased}
  a{color:inherit;text-decoration:none}
  .ipod-wrap{width:420px;max-width:94vw;margin:20px auto;padding:16px;
    background:linear-gradient(180deg,#26292d,#1b1b1b);
    border-radius:28px;box-shadow:0 30px 60px rgba(0,0,0,.6), inset 0 6px 20px rgba(255,255,255,.02);
    border:2px solid rgba(255,255,255,.03)}
  .screen{height:360px;background:#000;border-radius:12px;overflow:hidden;position:relative;
    box-shadow:inset 0 14px 40px rgba(0,0,0,.6), 0 10px 30px rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.02)}
  .header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;font-weight:600;font-size:13px;color:#e6e6e6;z-index:3}
  .header .title{font-weight:700}
  .header .icons{font-size:12px;color:#bdbdbd}
  .header .icons{display:flex;align-items:center;gap:10px;color:#cfdde6}
  .signal{display:flex;align-items:flex-end;gap:3px;height:12px}
  .signal span{width:3px;border-radius:2px;background:rgba(255,255,255,0.22);transition:background .18s,opacity .18s}
  .signal span.bar1{height:5px}
  .signal span.bar2{height:7px}
  .signal span.bar3{height:9px}
  .signal span.bar4{height:11px}
  .signal span.active{background:#cfdde6;opacity:1}
  .battery{position:relative;width:24px;height:12px;border:1px solid #cfdde6;border-radius:2px;overflow:hidden}
  .battery::after{content:"";position:absolute;top:3px;right:-3px;width:2px;height:6px;background:#cfdde6;border-radius:1px}
  .battery-level {height:100%;width:100%;background:#4caf50;border-radius:1px;transition:width 1s ease, background 1s ease;}
  .battery.charging .battery-level{animation:batt-pulse 1s infinite}
  @keyframes batt-pulse{0%{opacity:.85}50%{opacity:1}100%{opacity:.85}}
  .content{position:relative;height:calc(100% - 42px);display:flex;background:linear-gradient(180deg,#061220 0%, #0b1720 100%)}
  .leftPane{
    width:56%;min-width:140px;padding:14px;display:flex;flex-direction:column;justify-content:center;align-items:center;
    background-size:cover;background-position:center;position:relative;transition:width .36s cubic-bezier(.2,.9,.3,1),opacity .36s;
    border-right:1px solid rgba(255,255,255,.02);
    overflow:hidden;
  }
  .leftPane.hidden{width:5%;opacity:.38;padding:8px 6px;min-width:54px}
  .leftOverlay{position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.75));z-index:1}
  .artistAvatar{width:110px;height:110px;border-radius:10px;object-fit:cover;z-index:2;box-shadow:0 12px 30px rgba(0,0,0,.6)}
  .nowInfo{width:92%;position:relative;z-index:2;margin-top:12px;text-align:center}
  .nowInfo .title{font-weight:800;font-size:16px;color:#fff}
  .nowInfo .artist{font-size:12px;color:#d7e6ef;margin-top:4px}
  .bigProgress{width:92%;height:8px;background:rgba(255,255,255,.06);border-radius:10px;margin-top:10px;overflow:hidden;z-index:2}
  .bigProgress .bar{height:100%;width:0%;background:linear-gradient(90deg,#6aff80,#03742d);transition:width .12s linear}
  .rightPane{width:44%;padding:12px;display:flex;flex-direction:column;gap:8px;justify-content:flex-start;align-items:flex-start;overflow:auto;transition:width .36s cubic-bezier(.2,.9,.3,1)}
  .rightPane.full{width:95%}
  .menu{list-style:none;padding:8px 6px;width:100%;color:#fff;overflow:auto}
  .menu li{padding:10px 12px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.02));
    display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:transform .12s,background .12s;outline:none}
  .menu li:focus{box-shadow:0 0 0 3px rgba(26,140,255,.12)}
  .menu li:hover{transform:translateX(4px)}
  .menu li.selected{background: linear-gradient(180deg, #e1dd90, #333232);transform:translateX(6px);color:#012;font-weight:700}
  .menu li .subtitle{font-size:12px;color:rgba(255,255,255,.7)}
  .page{display:none;padding:6px;height:100%;overflow:auto; -webkit-overflow-scrolling: touch;}
  .page.active{display:block;animation:fadeIn .24s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .bio .avatar{width:100%;height:160px;border-radius:10px;object-fit:cover;margin-bottom:12px}
  .bio h3{margin-bottom:8px}
  .bio p{color:#e9eef2;line-height:1.5;font-size:14px}
  .nowPlaying{display:flex;flex-direction:column;align-items:center;gap:12px;padding:6px;height:100%;justify-content:flex-start}
  .nowPlaying .art{width:60%;max-width:320px;height:auto;border-radius:12px;box-shadow:0 18px 40px rgba(0,0,0,.7)}
  .nowPlaying .meta{width:90%;text-align:center}
  .nowPlaying .meta .song{font-weight:800;font-size:18px}
  .nowPlaying .meta .artist{font-size:13px;color:#cfdde6;margin-top:6px}
  .timeRow{width:90%;Display:flex;justify-content:space-between;font-size:12px;color:#bfcfd6;margin-top:6px}
  .timeRowSmall {width: 92%;display: flex;justify-content: space-between;font-size: 11px;color: #bfcfd6;margin: 6px 0 4px 0; z-index: 2;}
  .tracks{width:100%;margin-top:8px}
  .track{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,.03);margin-bottom:8px;cursor:pointer}
  .track:hover{background:rgba(255,255,255,.05)}
  .track button{background:linear-gradient(180deg,#1db954,#17a44a);border:none;padding:6px 10px;border-radius:6px;color:#022;font-weight:700;cursor:pointer}
  .galleryGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .galleryGrid img{width:100%;height:110px;object-fit:cover;border-radius:8px;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.5);transition:transform .25s}
  .galleryGrid img:hover{transform:scale(1.02)}
  .socials{display:flex;flex-direction:column;gap:8px}
  .socials a{padding:10px;border-radius:8px;background:rgba(255,255,255,.03);color:#fff;display:flex;align-items:center;gap:8px;cursor:pointer}
  .controls{display:flex;justify-content:center;padding:14px}
  .wheel{width:240px;height:240px;border-radius:50%;background:radial-gradient(circle at 30% 25%,#2b2b2b 0%,#111 60%);position:relative;box-shadow:0 20px 50px rgba(0,0,0,.7),inset 0 6px 20px rgba(255,255,255,.02)}
  .wheel button{background:none;border:none;color:inherit;font:inherit;padding:0;margin:0}
  .wheel .center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:96px;height:96px;border-radius:50%;background:radial-gradient(circle at 30% 25%,#151515 0%,#000 70%);box-shadow:inset 0 6px 18px rgba(255,255,255,.02);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;cursor:pointer}
  .wheel .btn-menu{position:absolute;top:14%;left:50%;transform:translateX(-50%);font-size:12px;color:#d9d9d9;cursor:pointer}
  .wheel .btn-prev{position:absolute;left:14%;top:50%;transform:translateY(-50%);width:20px;height:20px;cursor:pointer}
  .wheel .btn-next{position:absolute;right:14%;top:50%;transform:translateY(-50%);width:20px;height:20px;cursor:pointer}
  .wheel .btn-play{position:absolute;bottom:14%;left:50%;transform:translateX(-50%);width:20px;height:20px;cursor:pointer}
  .wheel .tiny{font-size:15px;font-weight: bold;color:rgba(255,255,255,.75)}
  .wheel .btn-prev::before,.wheel .btn-prev::after{content:"";display:inline-block;border-style:solid;border-width:5px 6px 5px 0;border-color:transparent #d9d9d9 transparent transparent;margin-right:1px}
  .wheel .btn-prev::after{margin-right:0}
  .wheel .btn-next::before,.wheel .btn-next::after{content:"";display:inline-block;border-style:solid;border-width:5px 0 5px 6px;border-color:transparent transparent transparent #d9d9d9;margin-left:1px}
  .wheel .btn-next::before{margin-left:0}
  .wheel .btn-play::before,.wheel .btn-play::after{content:"";display:inline-block;vertical-align:middle}
  .wheel .btn-play::before{border-style:solid;border-width:6px 0 6px 9px;border-color:transparent transparent transparent #d9d9d9;margin-right:3px}
  .wheel .btn-play::after{width:3px;height:10px;background:#d9d9d9;box-shadow:4px 0 0 #d9d9d9}
  .photoModal{position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:60;opacity:0;pointer-events:none;transition:opacity .28s ease}
  .photoModal.open{opacity:1;pointer-events:auto}
  .photoModal .photoFrame{width:92%;height:82%;max-width:760px;max-height:520px;border-radius:12px;overflow:hidden;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative}
  .photoModal img{width:100%;height:100%;object-fit:contain;background:#000}
  .photoModal .thumbs{height:70px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.04));display:flex;gap:8px;padding:8px;overflow:auto}
  .photoModal .thumbs img{height:54px;border-radius:6px;cursor:pointer;opacity:.9;border:2px solid transparent}
  .photoModal .thumbs img.active{border-color:#2aa6ff;opacity:1}
  .photoModal .closeBtn,
  .photoModal .navBtn {position:absolute;width:44px;height:44px;border-radius:50%;background:rgba(30,30,30,0.65);backdrop-filter:blur(6px);color:#fff;border:none;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;transition:all 0.25s ease;box-shadow:0 4px 12px rgba(0,0,0,0.4);z-index:10;}
  .photoModal .closeBtn:hover, .photoModal .navBtn:hover { background:rgba(255,255,255,0.9);color:#111;transform:scale(1.1);}
  .photoModal .closeBtn {top:20px;right:20px;font-size:20px;}
  .photoModal .navBtn.navPrev {left:20px;top:50%;transform:translateY(-50%); font-size: 40px;}
  .photoModal .navBtn.navNext { right:20px;top:50%;transform:translateY(-50%);font-size: 40px;}
  button, .menu li, .track, .galleryGrid img, .wheel .center, .wheel .btn-menu, .wheel .btn-prev, .wheel .btn-next, .wheel .btn-play, .socials a{cursor:pointer}
  .rightPane::-webkit-scrollbar, .menu::-webkit-scrollbar, .page::-webkit-scrollbar, .photoModal .thumbs::-webkit-scrollbar {height:8px;width:8px}
  .rightPane::-webkit-scrollbar-thumb, .menu::-webkit-scrollbar-thumb, .page::-webkit-scrollbar-thumb, .photoModal .thumbs::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,.08); border-radius:8px;
  }
  .rightPane::-webkit-scrollbar-track, .menu::-webkit-scrollbar-track, .page::-webkit-scrollbar-track, .photoModal .thumbs::-webkit-scrollbar-track {
    background: transparent;
  }
  .rightPane, .menu, .page { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.08) transparent; }
  .no-transition * { transition: none !important; }
  #playingArt {width: 60%;max-width: 320px;aspect-ratio: 1 / 1;background: rgba(255,255,255,.05);object-fit: cover;border-radius: 12px; display: block;}
  #nowPlaying { min-height: 280px;}
  /* estilos para la página de juegos */
  .game-canvas { width: 100%; height: 100%; background: linear-gradient(180deg,#031022,#051430); border-radius:10px; display:block; }
  .game-hud { display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#cfe8ff;padding:6px 4px }
  .game-controls { display:flex;gap:6px;align-items:center }
  .smallBtn { padding:6px 8px;border-radius:6px;background:rgba(255,255,255,.03);border:none;color:#fff }
</style>
</head>
<body>
  <div class="ipod-wrap" role="application" aria-label="iPod Portfolio final">
    <div class="screen" id="screen">
      <div class="header">
        <div class="title" id="headerTitle">9:41 AM • Music</div>
        <div class="icons">
          <div class="signal" id="signalIcon"><span class="bar1"></span><span class="bar2"></span><span class="bar3"></span><span class="bar4"></span></div>
          <div class="battery" id="batteryWrap"><div class="battery-level" id="batteryLevel"></div></div>
        </div>
      </div>

      <div class="content" id="content">
        <!-- LEFT -->
        <div class="leftPane" id="leftPane">
          <div class="leftOverlay" aria-hidden="true"></div>
          <img id="artistAvatar" class="artistAvatar" src="" alt="Artista">
          <div class="nowInfo" aria-live="polite">
            <div class="title" id="nowTitle">Nombre del Tema</div>
            <div class="artist" id="nowArtist">Nombre del Artista</div>
            <div class="timeRowSmall">
              <div id="leftTimeCurrent">0:00</div>
              <div id="leftTimeTotal">0:00</div>
            </div>
            <div class="bigProgress">
              <div class="bar" id="bigBar" style="width:0%"></div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="rightPane" id="rightPane">
          <ul id="menuList" class="menu" role="menu" aria-label="Menu principal"></ul>

          <div id="page-bio" class="page" role="document" aria-hidden="true">
            <h3>Biografía</h3>
            <img src="img/main.webp" alt="Foto artista" class="avatar" style="width:100%;height:160px;object-fit:cover;border-radius:10px;margin-bottom:10px">
            <div class="bio">
              <p><strong>Sebastián Yepes</strong> — Sebastián Yepes Alzate músico colombiano, nacido en la ciudad de Manizales Departamento de Caldas en el eje cafetero Colombiano, el 10 de junio de 1980. Ex-vocalista de la agrupación Sanalejo.</p>
            </div>
          </div>

          <div id="page-music" class="page" role="document" aria-hidden="true">
            <div class="nowPlaying" id="nowPlaying">
              <img src="" class="art" id="playingArt" alt="Carátula">
              <div class="meta">
                <div class="song" id="playingTitle">Track One</div>
                <div class="artist" id="playingArtist">Nombre del Artista</div>
                <div class="timeRow">
                  <div id="timeCurrent">0:00</div>
                  <div id="timeTotal">0:00</div>
                </div>
                <div class="bigProgress" style="margin-top:8px"><div class="bar" id="mainBar" style="width:0%"></div></div>
              </div>

              <div class="tracks" id="tracksList" aria-label="Lista de pistas"></div>
            </div>
            <audio id="player" preload="metadata"></audio>
          </div>

          <div id="page-photos" class="page" role="document" aria-hidden="true">
            <h3>Fotos</h3>
            <div class="galleryGrid" id="galleryGrid" aria-label="Galería"></div>
          </div>

          <div id="page-social" class="page" role="document" aria-hidden="true">
            <h3>Redes</h3>
            <div class="socials">
              <a href="https://instagram.com" target="_blank" rel="noopener noreferrer">📸 Instagram</a>
              <a href="https://facebook.com" target="_blank" rel="noopener noreferrer">📘 Facebook</a>
            </div>
          </div>

          <!-- Página nueva: Juegos -->
          <div id="page-games" class="page" role="document" aria-hidden="true">
            <div class="game-hud">
              <div>JUEGOS</div>
              <div class="game-controls">
                <button id="gameRestart" class="smallBtn">Reiniciar</button>
                <button id="gamePause" class="smallBtn">Pausa</button>
              </div>
            </div>
            <canvas id="gameCanvas" class="game-canvas" width="320" height="240" aria-label="Canvas de juego"></canvas>
            <div style="height:8px"></div>
            <div style="font-size:12px;color:#cfe8ff;padding:4px">Usa la rueda para mover la paleta. Pulsa OK para iniciar/pausar.</div>
          </div>

        </div>
      </div>
    </div>

    <!-- Wheel -->
    <div class="controls" aria-hidden="false">
      <div class="wheel" id="wheel" role="group" aria-label="Rueda de control">
        <button class="btn-menu tiny" id="btn-menu" aria-pressed="false">MENU</button>
        <button class="btn-prev tiny" id="btn-prev" aria-label="Anterior"></button>
        <button class="btn-next tiny" id="btn-next" aria-label="Siguiente"></button>
        <button class="center" id="btn-select" aria-pressed="false">OK</button>
        <button class="btn-play tiny" id="btn-play" aria-pressed="false"></button>
      </div>
    </div>

  <!-- Photo modal -->
  <div class="photoModal" id="photoModal" aria-hidden="true" role="dialog" aria-label="Foto ampliada">
    <div class="photoFrame" role="document">
      <button class="closeBtn" id="photoClose" aria-label="Cerrar foto">✕</button>
      <button class="navBtn navPrev" id="photoPrev" aria-label="Anterior foto">◂</button>
      <button class="navBtn navNext" id="photoNext" aria-label="Siguiente foto">▸</button>
      <img id="modalImg" alt="Foto ampliada">
      <div class="thumbs" id="photoThumbs" aria-hidden="false"></div>
    </div>
  </div>

<script>
/* ===== Datos ===== */
const DATA = {
  artist: {
    name: 'Sebastián Yepes',
    cover: 'https://picsum.photos/900/900?random=15',
    avatar: 'img/artist.webp'
  },
  menu:[
    { id:'bio', label:'Biografía', subtitle:'Sobre el artista' },
    { id:'music', label:'Música', subtitle:'Pistas & demos' },
    { id:'photos', label:'Fotos', subtitle:'Galería visual' },
    { id:'social', label:'Redes', subtitle:'Instagram / Facebook' },
    { id:'games', label:'Juegos', subtitle:'Pong rápido (rueda)' } // nuevo elemento
  ],
  tracks:[
    { title:'No me veré caer', src:'assets/track1.mp3', length:'3:22', art:'img/track1.webp' },
    { title:'Track Two', src:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3', length:'4:02', art:'https://picsum.photos/600/600?random=14' },
    { title:'Ambient Demo', src:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3', length:'2:48', art:'https://picsum.photos/600/600?random=16' }
  ],
  gallery:[
    'img/pic1.webp',
    'img/pic2.webp',
    'img/pic3.webp',
    'img/pic4.webp'
  ]
};

/* ===== Referencias DOM ===== */
const leftPane = document.getElementById('leftPane');
const artistAvatar = document.getElementById('artistAvatar');
const nowTitle = document.getElementById('nowTitle');
const nowArtist = document.getElementById('nowArtist');
const bigBar = document.getElementById('bigBar');

const leftTimeCurrent = document.getElementById('leftTimeCurrent');
const leftTimeTotal = document.getElementById('leftTimeTotal');

const menuList = document.getElementById('menuList');
const pages = {
  bio: document.getElementById('page-bio'),
  music: document.getElementById('page-music'),
  photos: document.getElementById('page-photos'),
  social: document.getElementById('page-social'),
  games: document.getElementById('page-games') // nueva página
};

const tracksList = document.getElementById('tracksList');
const galleryGrid = document.getElementById('galleryGrid');

const player = document.getElementById('player');
const playingArt = document.getElementById('playingArt');
const playingTitle = document.getElementById('playingTitle');
const playingArtist = document.getElementById('playingArtist');
const mainBar = document.getElementById('mainBar');
const timeCurrent = document.getElementById('timeCurrent');
const timeTotal = document.getElementById('timeTotal');

const btnSelect = document.getElementById('btn-select');
const btnMenu = document.getElementById('btn-menu');
const btnPrev = document.getElementById('btn-prev');
const btnNext = document.getElementById('btn-next');
const btnPlay = document.getElementById('btn-play');

const photoModal = document.getElementById('photoModal');
const modalImg = document.getElementById('modalImg');
const photoThumbs = document.getElementById('photoThumbs');
const photoClose = document.getElementById('photoClose');
const photoPrev = document.getElementById('photoPrev');
const photoNext = document.getElementById('photoNext');

const wheel = document.getElementById('wheel');

/* ===== Estado global ===== */
let currentMenuIndex = 0;
let inPage = false;
let currentPageId = null;
let currentTrackIndex = 0;
let currentPhotoIndex = 0;

/* ===== MSE globals (sin cambios) ===== */
let currentMSE = { mediaSource: null, sourceBuffer: null, objectUrl: null, fetchController: null, queue: [], isUsingMSE: false };

/* ===== Util helpers ===== */
function isInsideButton(target){ return !!target.closest('button'); }
function scrollActivePage(steps, direction){
  if(!inPage || !currentPageId) return;
  const active = pages[currentPageId];
  if(!active) return;
  const amount = 80 * steps * direction;
  const maxScroll = active.scrollHeight - active.clientHeight;
  const desired = active.scrollTop + amount;
  const clamped = Math.max(0, Math.min(maxScroll, desired));
  active.scrollTo({top: clamped, behavior: 'smooth'});
}

/* ===== Inicialización UI ===== */
function initArtist(){
  leftPane.style.backgroundImage = `url('${DATA.artist.cover}')`;
  artistAvatar.src = DATA.artist.avatar;
  nowArtist.textContent = DATA.artist.name;
}
function renderMenu(){
  menuList.innerHTML = '';
  DATA.menu.forEach((m,i)=>{
    const li = document.createElement('li');
    li.tabIndex = 0;
    li.dataset.id = m.id;
    li.setAttribute('role','menuitem');
    if(i===currentMenuIndex){
      li.className = 'selected';
      setTimeout(()=> li.scrollIntoView({block:'nearest', behavior:'smooth'}), 0);
    }
    li.innerHTML = `<div><div style="font-size:14px">${m.label}</div><div class="subtitle">${m.subtitle}</div></div><div>›</div>`;
    li.addEventListener('click', ()=> { activateMenuIndex(i); });
    li.addEventListener('keydown', (e)=>{ if(e.key==='Enter') activateMenuIndex(i); });
    menuList.appendChild(li);
  });
}


/* muestra/oculta páginas */
function showPage(id){
  const rightPane = document.getElementById('rightPane');

  if(!id){
    inPage = false;
    currentPageId = null;
    leftPane.classList.remove('hidden');
    rightPane.classList.remove('full');
    Object.values(pages).forEach(p => { 
      p.classList.remove('active'); 
      p.setAttribute('aria-hidden','true'); 
    });
    menuList.style.display = 'block';
    setTimeout(()=> renderMenu(), 160);
    // si veníamos de juegos, detener juego
    if(window.Game && window.Game.running) window.Game.stop();
    return;
  }

  inPage = true;
  currentPageId = id;

  document.body.classList.add("no-transition");

  menuList.style.display = 'none';
  leftPane.classList.add('hidden');
  rightPane.classList.add('full');

  rightPane.style.width = "95%";
  leftPane.style.width = "5%";
  rightPane.offsetHeight;

  requestAnimationFrame(()=>{
    document.body.classList.remove("no-transition");
    rightPane.style.width = "";
    leftPane.style.width = "";
  });

  Object.values(pages).forEach(p => { 
    p.classList.remove('active'); 
    p.setAttribute('aria-hidden','true'); 
  });
  pages[id].classList.add('active');
  pages[id].setAttribute('aria-hidden','false');

  requestAnimationFrame(()=> {
    pages[id].scrollTop = 0;
    if(id === 'music'){ openMusic(); }
    if(id === 'photos'){ populateGallery(); }
    if(id === 'games'){ // iniciar juego cuando se entre a la página
      if(window.Game) window.Game.start();
    }
  });
}

function activateMenuIndex(i){
  currentMenuIndex = i;
  renderMenu();
  showPage(DATA.menu[i].id);
}

/* ===== Tracks & Now Playing ===== */
function populateTracks(){
  tracksList.innerHTML = '';
  DATA.tracks.forEach((t,i) => {
    const div = document.createElement('div');
    div.className = 'track';
    div.tabIndex = 0;
    div.innerHTML = `<div><strong>${t.title}</strong><div style="font-size:12px;color:#cfd8dc">${t.length}</div></div><div><button aria-label="Reproducir ${t.title}">Play</button></div>`;
    div.querySelector('button').addEventListener('click', (ev) => { ev.stopPropagation(); playTrack(i); });
    div.addEventListener('click', ()=> playTrack(i));
    div.addEventListener('keydown', (e)=>{ if(e.key==='Enter') playTrack(i); });
    tracksList.appendChild(div);
  });
}

function playTrack(i){
  if(i < 0 || i >= DATA.tracks.length) return;
  if(i === currentTrackIndex && player.src && player.paused){
    player.play().catch(()=>{});
    return;
  }
  cleanupCurrentMSE();
  currentTrackIndex = i;
  const t = DATA.tracks[i];
  loadTrackWithMSE(t.src).then((usedMSE) => {
    if(!usedMSE){
      player.src = t.src;
      player.preload = 'auto';
      player.play().catch(()=>{});
    }
  }).catch((err)=>{
    player.src = t.src;
    player.preload = 'auto';
    player.play().catch(()=>{});
  });
  updateNowPlayingUI(t);
}

function updateNowPlayingUI(t){
  playingTitle.textContent = t.title;
  playingArtist.textContent = DATA.artist.name;
  playingArt.src = t.art || DATA.artist.avatar || "img/placeholder.png";
  nowTitle.textContent = t.title;
  nowArtist.textContent = DATA.artist.name;
  leftPane.style.backgroundImage = `url('${t.art || DATA.artist.cover}')`;
}

function openMusic(){
  populateTracks();
  if(!player.src){
    currentTrackIndex = 0;
    const first = DATA.tracks[0];
    player.src = first.src;
    player.preload = "metadata";
    player.pause();
    playingArt.src = first.art || DATA.artist.avatar;
    playingTitle.textContent = first.title;
    playingArtist.textContent = DATA.artist.name;
    nowTitle.textContent = first.title;
    nowArtist.textContent = DATA.artist.name;
    leftPane.style.backgroundImage = `url('${first.art || DATA.artist.cover}')`;
  }
}

/* ========== MSE (sin cambios funcionales importantes) ========== */
async function loadTrackWithMSE(url){
  if(!('MediaSource' in window)) return false;
  try{
    const headResp = await fetch(url, { method: 'HEAD' });
    const acceptRanges = headResp.headers.get('accept-ranges') || '';
    const contentLengthHeader = headResp.headers.get('content-length');
    const contentLength = contentLengthHeader ? parseInt(contentLengthHeader, 10) : NaN;
    const supportsRange = acceptRanges.toLowerCase().includes('bytes');
    if(!supportsRange || isNaN(contentLength)) return false;
    const mime = 'audio/mpeg';
    const mediaSource = new MediaSource();
    currentMSE.mediaSource = mediaSource;
    currentMSE.queue = [];
    currentMSE.fetchController = new AbortController();
    currentMSE.isUsingMSE = true;
    const objectUrl = URL.createObjectURL(mediaSource);
    currentMSE.objectUrl = objectUrl;
    player.src = objectUrl;
    await new Promise((resolve, reject) => {
      const onSourceOpen = () => {
        try{
          const sb = mediaSource.addSourceBuffer(mime);
          currentMSE.sourceBuffer = sb;
          resolve();
        }catch(err){ reject(err); }
        finally { mediaSource.removeEventListener('sourceopen', onSourceOpen); }
      };
      mediaSource.addEventListener('sourceopen', onSourceOpen);
      setTimeout(()=> {
        if(mediaSource.readyState !== 'open') reject(new Error('MediaSource open timeout'));
      }, 5000);
    });
    const chunkSize = 64 * 1024;
    let start = 0;
    const total = contentLength;
    const sb = currentMSE.sourceBuffer;
    function appendBufferChunk(ab){
      if(!sb) return;
      if(sb.updating) currentMSE.queue.push(ab);
      else sb.appendBuffer(ab);
    }
    sb.addEventListener('updateend', ()=>{
      if(currentMSE.queue.length){
        const next = currentMSE.queue.shift();
        try{ sb.appendBuffer(next); } catch(e){ console.error(e); }
      }
    });
    const controller = currentMSE.fetchController;
    const signal = controller.signal;
    let appendedFirstChunk = false;
    while(start < total){
      if(signal.aborted) throw new Error('aborted');
      const end = Math.min(start + chunkSize - 1, total - 1);
      const rangeHeader = `bytes=${start}-${end}`;
      const resp = await fetch(url, { headers: { Range: rangeHeader }, signal });
      if(!resp.ok && resp.status !== 206) throw new Error('Range request failed with status ' + resp.status);
      const arrayBuffer = await resp.arrayBuffer();
      appendBufferChunk(arrayBuffer);
      if(!appendedFirstChunk){
        appendedFirstChunk = true;
        player.play().catch(()=>{});
      }
      start += chunkSize;
    }
    const waitForAllAppended = () => new Promise((resolve) => {
      const check = () => {
        if(!sb.updating && currentMSE.queue.length === 0) resolve();
        else setTimeout(check, 50);
      };
      check();
    });
    await waitForAllAppended();
    try{ if(currentMSE.mediaSource && currentMSE.mediaSource.readyState === 'open'){ currentMSE.mediaSource.endOfStream(); } }catch(e){}
    return true;
  }catch(err){
    cleanupCurrentMSE();
    console.warn('MSE pipeline error', err);
    return false;
  }
}

function cleanupCurrentMSE(){
  try{ if(currentMSE.fetchController) currentMSE.fetchController.abort(); }catch(e){}
  try{
    if(currentMSE.sourceBuffer && currentMSE.mediaSource && currentMSE.mediaSource.readyState === 'open'){
      try{ currentMSE.mediaSource.removeSourceBuffer(currentMSE.sourceBuffer); } catch(e){}
    }
  }catch(e){}
  try{ if(currentMSE.objectUrl) URL.revokeObjectURL(currentMSE.objectUrl); }catch(e){}
  currentMSE = { mediaSource: null, sourceBuffer: null, objectUrl: null, fetchController: null, queue: [], isUsingMSE: false };
}

/* player events */
player.addEventListener('loadedmetadata', ()=> { 
  if(timeTotal) timeTotal.textContent = formatTime(player.duration || 0);
  if(leftTimeTotal) leftTimeTotal.textContent = formatTime(player.duration || 0);
});
player.addEventListener('timeupdate', ()=> {
  if(player.duration && !isNaN(player.duration)){
    const pct = Math.max(0, Math.min(100, (player.currentTime / player.duration) * 100));
    if(mainBar) mainBar.style.width = pct + '%';
    if(bigBar) bigBar.style.width = pct + '%';
    if(timeCurrent) timeCurrent.textContent = formatTime(player.currentTime);
    if(timeTotal) timeTotal.textContent = formatTime(player.duration);
    if(leftTimeCurrent) leftTimeCurrent.textContent = formatTime(player.currentTime);
    if(leftTimeTotal) leftTimeTotal.textContent = formatTime(player.duration);
  }
});
player.addEventListener('ended', ()=> {
  const next = (currentTrackIndex + 1) % DATA.tracks.length;
  playTrack(next);
});
function formatTime(s){ if(!s || isNaN(s)) return '0:00'; const min = Math.floor(s/60); const sec = Math.floor(s%60).toString().padStart(2,'0'); return `${min}:${sec}`; }

/* ===== Gallery & Modal ===== */
function populateGallery(){
  galleryGrid.innerHTML = '';
  DATA.gallery.forEach((url, idx)=>{
    const img = document.createElement('img');
    img.src = url; img.alt = 'Foto artista';
    img.tabIndex = 0;
    img.addEventListener('click', ()=> openPhoto(idx));
    img.addEventListener('keydown', (e)=>{ if(e.key==='Enter') openPhoto(idx); });
    galleryGrid.appendChild(img);
  });
}
function openPhoto(index){
  if(index < 0 || index >= DATA.gallery.length) return;
  currentPhotoIndex = index;
  modalImg.src = DATA.gallery[index];
  photoModal.classList.add('open'); photoModal.setAttribute('aria-hidden','false');
  buildPhotoThumbs(); highlightActiveThumb();
}
function closePhoto(){ photoModal.classList.remove('open'); photoModal.setAttribute('aria-hidden','true'); modalImg.src=''; }
function buildPhotoThumbs(){
  photoThumbs.innerHTML = '';
  DATA.gallery.forEach((u,i)=>{
    const t = document.createElement('img'); t.src = u; t.alt='Miniatura'; t.tabIndex=0;
    t.addEventListener('click', ()=> openPhoto(i)); t.addEventListener('keydown', (e)=>{ if(e.key==='Enter') openPhoto(i); });
    if(i===currentPhotoIndex) t.classList.add('active');
    photoThumbs.appendChild(t);
  });
}
function highlightActiveThumb(){ const thumbs = photoThumbs.querySelectorAll('img'); thumbs.forEach((img,i)=> img.classList.toggle('active', i===currentPhotoIndex)); }

photoPrev.addEventListener('click', ()=> { currentPhotoIndex=(currentPhotoIndex-1+DATA.gallery.length)%DATA.gallery.length; modalImg.src = DATA.gallery[currentPhotoIndex]; highlightActiveThumb(); });
photoNext.addEventListener('click', ()=> { currentPhotoIndex=(currentPhotoIndex+1)%DATA.gallery.length; modalImg.src = DATA.gallery[currentPhotoIndex]; highlightActiveThumb(); });
photoClose.addEventListener('click', closePhoto);
photoModal.addEventListener('click', (e)=> { if(e.target === photoModal) closePhoto(); });
modalImg.addEventListener('click', (e)=> e.stopPropagation());

/* ===== Wheel rotation (entrada para la rueda) ===== */
let tracking=false, lastAngle=null, accumulator=0;
const THRESH = 18; // sensibilidad de cada "paso"

/* calcula ángulo desde evento */
function angleFromEvent(e){
  const rect = wheel.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top + rect.height/2;
  const ev = (e.touches && e.touches[0]) ? e.touches[0] : e;
  const x = ev.clientX - cx;
  const y = ev.clientY - cy;
  return Math.atan2(y, x) * 180 / Math.PI;
}

/* procesar pasos detectados por la rueda
   dir: 1 => sentido horario (bajar), -1 => antihorario (subir) */
function step(delta){
  if(delta > 60) delta = 60;
  if(delta < -60) delta = -60;

  accumulator += delta;
  const maxAccum = THRESH * 4;
  if(accumulator > maxAccum) accumulator = maxAccum;
  if(accumulator < -maxAccum) accumulator = -maxAccum;

  if(Math.abs(accumulator) >= THRESH){
    const steps = Math.floor(Math.abs(accumulator) / THRESH);
    const dir = accumulator > 0 ? 1 : -1;
    accumulator = accumulator - dir * steps * THRESH;

    // comportamiento específico si estamos en la página de juegos
    if(inPage && currentPageId === 'games' && window.Game){
      window.Game.handleWheel(dir * steps); // control del juego por la rueda
    } else if(!inPage){
      currentMenuIndex = (currentMenuIndex + dir * steps + DATA.menu.length) % DATA.menu.length;
      renderMenu();
    } else {
      if(currentPageId === 'photos' && photoModal.classList.contains('open')){
        currentPhotoIndex = (currentPhotoIndex + dir * steps + DATA.gallery.length) % DATA.gallery.length;
        modalImg.src = DATA.gallery[currentPhotoIndex];
        highlightActiveThumb();
      } else {
        scrollActivePage(steps, dir);
      }
    }

    if(navigator.vibrate) navigator.vibrate(6);
  }
}

/* eventos de puntero/táctil para la rueda */
wheel.addEventListener('pointerdown', (e)=>{
  if(isInsideButton(e.target)) return;
  tracking = true;
  lastAngle = angleFromEvent(e);
  try{ wheel.setPointerCapture && wheel.setPointerCapture(e.pointerId); }catch(err){}
});
wheel.addEventListener('pointermove', (e)=>{
  if(!tracking) return;
  const a = angleFromEvent(e);
  let delta = a - lastAngle;
  if(delta > 180) delta -= 360;
  if(delta < -180) delta += 360;
  lastAngle = a;
  if(delta > 60) delta = 60;
  if(delta < -60) delta = -60;
  step(delta);
});
wheel.addEventListener('pointerup', (e)=>{
  tracking=false; lastAngle=null; accumulator=0;
  try{ wheel.releasePointerCapture && wheel.releasePointerCapture(e.pointerId); }catch(err){}
});
wheel.addEventListener('touchstart', (e)=>{
  if(isInsideButton(e.target)) return;
  tracking=true; lastAngle = angleFromEvent(e);
}, {passive:false});
wheel.addEventListener('touchmove', (e)=>{
  if(!tracking) return;
  const a = angleFromEvent(e);
  let delta = a - lastAngle;
  if(delta > 180) delta -= 360;
  if(delta < -180) delta += 360;
  lastAngle = a;
  if(delta > 60) delta = 60;
  if(delta < -60) delta = -60;
  step(delta);
  e.preventDefault();
}, {passive:false});
wheel.addEventListener('touchend', ()=>{ tracking=false; lastAngle=null; accumulator=0; });

/* ===== Botones de la rueda ===== */
function safePlayToggle(){
  if(!player.src) { playTrack(0); return; }
  if(player.paused) { player.play().catch(()=>{}); }
  else { player.pause(); }
}

document.getElementById('btn-select').addEventListener('click', ()=>{
  if(!inPage){
    const id = DATA.menu[currentMenuIndex].id;
    showPage(id);
  } else {
    if(currentPageId === 'music') safePlayToggle();
    else if(currentPageId === 'photos') openPhoto(0);
    else if(currentPageId === 'games' && window.Game) window.Game.togglePause();
  }
});
document.getElementById('btn-menu').addEventListener('click', ()=>{
  if(inPage) showPage(null);
  else { currentMenuIndex = 0; renderMenu(); }
});
document.getElementById('btn-prev').addEventListener('click', ()=>{
  if(!inPage){
    const prev = (currentTrackIndex - 1 + DATA.tracks.length) % DATA.tracks.length;
    playTrack(prev);
  } else if(currentPageId === 'music'){
    const prev = (currentTrackIndex - 1 + DATA.tracks.length) % DATA.tracks.length; playTrack(prev);
  } else if(currentPageId === 'photos'){
    if(photoModal.classList.contains('open')) photoPrev.click(); else openPhoto(DATA.gallery.length - 1);
  } else {
    if(currentPageId) pages[currentPageId].scrollBy({top:-80, behavior:'smooth'});
  }
});
document.getElementById('btn-next').addEventListener('click', ()=>{
  if(!inPage){
    const next = (currentTrackIndex + 1) % DATA.tracks.length;
    playTrack(next);
  } else if(currentPageId === 'music'){
    const next = (currentTrackIndex + 1) % DATA.tracks.length; playTrack(next);
  } else if(currentPageId === 'photos'){
    if(photoModal.classList.contains('open')) photoNext.click(); else openPhoto(0);
  } else {
    if(currentPageId) pages[currentPageId].scrollBy({top:80, behavior:'smooth'});
  }
});
document.getElementById('btn-play').addEventListener('click', ()=> safePlayToggle());

/* ===== Soporte teclado y accesibilidad ===== */
window.addEventListener('keydown', (e)=>{
  if(e.key === 'ArrowUp'){ currentMenuIndex = (currentMenuIndex - 1 + DATA.menu.length) % DATA.menu.length; renderMenu(); }
  if(e.key === 'ArrowDown'){ currentMenuIndex = (currentMenuIndex + 1) % DATA.menu.length; renderMenu(); }
  if(e.key === 'Enter'){ document.getElementById('btn-select').click(); }
  if(e.key === 'Escape'){ document.getElementById('btn-menu').click(); if(photoModal.classList.contains('open')) closePhoto(); }
});

/* Live region accesible */
const live = document.createElement('div');
live.setAttribute('aria-live','polite'); live.style.position='absolute'; live.style.left='-9999px';
document.body.appendChild(live);
const mo = new MutationObserver(()=> live.textContent = DATA.menu[currentMenuIndex].label + ' seleccionado');
mo.observe(menuList,{childList:true,subtree:true});

/* ===== Swipe en páginas para volver al menú (móvil) ===== */
(function enablePageSwipeToLeft(){
  let startX = null, startY = null, trackingSwipe = false;
  const threshold = 50;
  function onStart(e){
    if(!inPage) return;
    const ev = (e.touches && e.touches[0]) ? e.touches[0] : e;
    startX = ev.clientX;
    startY = ev.clientY;
    trackingSwipe = true;
  }
  function onEnd(e){
    if(!trackingSwipe) return;
    const ev = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e;
    const dx = ev.clientX - startX;
    const dy = ev.clientY - startY;
    if(Math.abs(dx) > Math.abs(dy) && dx > threshold){
      showPage(null);
    }
    startX = null; startY = null; trackingSwipe = false;
  }
  Object.values(pages).forEach(p => {
    p.addEventListener('touchstart', onStart, {passive:true});
    p.addEventListener('touchend', onEnd, {passive:true});
    p.addEventListener('pointerdown', (ev)=> { if(ev.pointerType === 'touch') onStart(ev); }, {passive:true});
    p.addEventListener('pointerup', (ev)=> { if(ev.pointerType === 'touch') onEnd(ev); }, {passive:true});
  });
})();

/* ===== Inicializar ===== */
function init(){
  initArtist();
  renderMenu();
  populateTracks();

  currentTrackIndex = 0;
  const first = DATA.tracks[0];
  player.src = first.src;
  player.preload = "metadata";
  player.pause();
  updateNowPlayingUI(first);
  if(bigBar) bigBar.style.width = "0%";
}
init();

/* evitar arrastrar imágenes */
document.addEventListener('dragstart', (e)=>{ if(e.target.tagName === 'IMG') e.preventDefault(); });

/* swipe horizontal extra para mostrar/ocultar leftPane (comportamiento táctil) */
const content = document.getElementById("content");
let startX = 0;
content.addEventListener("touchstart", (e) => { startX = e.touches[0].clientX; }, { passive: true });
content.addEventListener("touchend", (e) => {
  let endX = e.changedTouches[0].clientX;
  let diffX = endX - startX;
  if (diffX > 50 && inPage) {
    const activePage = document.querySelector(".page.active");
    if (activePage) {
      activePage.classList.remove("active");
      document.getElementById("menuList").style.display = "block";
      inPage = false;
    }
  } else if (Math.abs(diffX) > 50 && !inPage) {
    if (diffX > 0) {
      document.getElementById("leftPane").classList.remove("hidden");
      document.getElementById("rightPane").classList.remove("full");
    } else {
      document.getElementById("leftPane").classList.add("hidden");
      document.getElementById("rightPane").classList.add("full");
    }
  }
}, { passive: true });

/* ===== STATUS ICONS (batería + señal) ===== */
(function initStatusIcons(){
  const battLevelEl = document.getElementById('batteryLevel');
  const batteryWrap = document.getElementById('batteryWrap');
  const signalWrap = document.getElementById('signalIcon');

  function setBatteryLevel(p){
    const clamped = Math.max(0, Math.min(1, p));
    battLevelEl.style.width = (clamped*100) + '%';
    let color = '#4caf50';
    if(clamped <= 0.15) color = '#f44336';
    else if(clamped <= 0.35) color = '#ffeb3b';
    battLevelEl.style.background = color;
    batteryWrap.classList.toggle('low', clamped <= 0.15);
  }

  let batteryLevel = 1.0;
  let discharging = true;

  function simulateBattery(){
    if(discharging){
      batteryLevel -= 0.05;
      if(batteryLevel <= 0){ batteryLevel = 0; discharging = false; }
    } else {
      batteryLevel += 0.05;
      if(batteryLevel >= 1){ batteryLevel = 1; discharging = true; }
    }
    setBatteryLevel(batteryLevel);
  }

  setBatteryLevel(batteryLevel);
  setInterval(simulateBattery, 60000);

  function renderSignal(effectiveType){
    const map = { 'slow-2g':1, '2g':1, '3g':2, '4g':4, 'wifi':4, undefined:3 };
    const bars = map[effectiveType] ?? 3;
    const spans = signalWrap.querySelectorAll('span');
    spans.forEach((s, i) => { if(i < bars) s.classList.add('active'); else s.classList.remove('active'); });
  }

  if(navigator.connection && navigator.connection.effectiveType){
    renderSignal(navigator.connection.effectiveType);
    try{ navigator.connection.addEventListener('change', ()=> renderSignal(navigator.connection.effectiveType)); }catch(e){}
  } else {
    renderSignal('4g');
  }
})();

/* ===== Reloj real ===== */
function updateClock() {
  const now = new Date();
  let hours = now.getHours();
  let minutes = now.getMinutes().toString().padStart(2, "0");
  let ampm = hours >= 12 ? "PM" : "AM";
  hours = hours % 12;
  hours = hours ? hours : 12;
  const timeString = `${hours}:${minutes} ${ampm} • Music`;
  document.getElementById("headerTitle").textContent = timeString;
}
updateClock();
setInterval(updateClock, 60000);

/* ======= JUEGO: Pong rápido controlado por la rueda =======
   Implementación clara, rápida y robusta.
   - La rueda mueve la paleta del jugador (izquierda).
   - Bola con velocidad alta y rebotes confiables.
   - OK pausa/continúa, botones reiniciar/pausa en HUD.
   - Separa la lógica del juego en window.Game para control externo.
================================================================*/
(function setupGame(){
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  // Tamaño de juego interno (escalable)
  const W = 320, H = 240;
  canvas.width = W; canvas.height = H;

  // Parámetros
  const paddleW = 8, paddleH = 44;
  const playerX = 10;
  const aiX = W - 10 - paddleW;
  const ballSize = 8;

  // Estado
  let playerY = (H - paddleH)/2;
  let aiY = (H - paddleH)/2;
  let ballX = W/2 - ballSize/2;
  let ballY = H/2 - ballSize/2;
  let ballVX = 220; // px/s
  let ballVY = 140; // px/s
  let lastTime = 0;
  let rafId = null;
  let running = false;
  let score = { player:0, ai:0 };
  let lastWheelMove = 0;

  // Ajustes de velocidad para que sea "muy rápido" pero estable
  const SPEED_MULT = 1.0; // se puede ajustar
  const aiSpeed = 160;

  // Limita paleta dentro del canvas
  function clampPaddle(y){ return Math.max(0, Math.min(H - paddleH, y)); }

  // Reiniciar estado del juego
  function reset(posRightWins=false){
    playerY = (H - paddleH)/2;
    aiY = (H - paddleH)/2;
    ballX = W/2 - ballSize/2;
    ballY = H/2 - ballSize/2;
    // dirección aleatoria pero rápida
    const angle = (Math.random() * 0.6 - 0.3); // -0.3..0.3 radians
    const dir = posRightWins ? -1 : (Math.random() < 0.5 ? -1 : 1);
    ballVX = dir * (200 + Math.random() * 120) * SPEED_MULT;
    ballVY = (150 + Math.random() * 120) * (Math.random()<0.5 ? -1 : 1) * SPEED_MULT;
  }

  // Dibujado con colores vivos
  function render(){
    ctx.clearRect(0,0,W,H);
    // fondo con gradiente
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#062235'); g.addColorStop(1,'#031022');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

    // líneas centrales
    ctx.fillStyle = 'rgba(255,255,255,0.06)';
    for(let y=0;y<H;y+=12) ctx.fillRect(W/2 - 1, y, 2, 8);

    // paletas
    ctx.fillStyle = '#6EE7B7'; ctx.fillRect(playerX, playerY, paddleW, paddleH); // jugador
    ctx.fillStyle = '#60A5FA'; ctx.fillRect(aiX, aiY, paddleW, paddleH); // IA

    // bola
    ctx.fillStyle = '#FF7AA2'; ctx.beginPath(); ctx.arc(ballX + ballSize/2, ballY + ballSize/2, ballSize/2, 0, Math.PI*2); ctx.fill();

    // marcador
    ctx.fillStyle = '#cfe8ff'; ctx.font = '14px system-ui, Arial'; ctx.fillText(`${score.player}`, W/2 - 40, 20); ctx.fillText(`${score.ai}`, W/2 + 30, 20);
  }

  function stepGame(ts){
    if(!running){ lastTime = ts; rafId = requestAnimationFrame(stepGame); return; }
    if(!lastTime) lastTime = ts;
    const dt = Math.min(0.05, (ts - lastTime)/1000); // dt en segundos, clamp para estabilidad
    lastTime = ts;

    // mover bola
    ballX += ballVX * dt;
    ballY += ballVY * dt;

    // colisiones superior/inferior
    if(ballY < 0){ ballY = 0; ballVY = Math.abs(ballVY); }
    if(ballY + ballSize > H){ ballY = H - ballSize; ballVY = -Math.abs(ballVY); }

    // colisión con paleta jugador
    if(ballX <= playerX + paddleW && ballX + ballSize >= playerX){
      if(ballY + ballSize >= playerY && ballY <= playerY + paddleH){
        ballX = playerX + paddleW;
        // calcular rebote según zona de la paleta
        const relative = (ballY + ballSize/2) - (playerY + paddleH/2);
        const norm = relative / (paddleH/2); // -1 .. 1
        const bounceAngle = norm * Math.PI/3; // <= 60°
        const speed = Math.hypot(ballVX, ballVY) * 1.05; // pequeño incremento
        ballVX = Math.abs(Math.cos(bounceAngle) * speed);
        ballVY = Math.sin(bounceAngle) * speed;
        // pequeño "empujón" para evitar pegajosidad
        lastWheelMove = performance.now();
      }
    }

    // colisión con paleta IA
    if(ballX + ballSize >= aiX && ballX <= aiX + paddleW){
      if(ballY + ballSize >= aiY && ballY <= aiY + paddleH){
        ballX = aiX - ballSize;
        const relative = (ballY + ballSize/2) - (aiY + paddleH/2);
        const norm = relative / (paddleH/2);
        const bounceAngle = norm * Math.PI/3;
        const speed = Math.hypot(ballVX, ballVY) * 1.02;
        ballVX = -Math.abs(Math.cos(bounceAngle) * speed);
        ballVY = Math.sin(bounceAngle) * speed;
      }
    }

    // marcador: fuera izquierda/derecha
    if(ballX + ballSize < 0){
      score.ai += 1;
      reset(false);
    } else if(ballX > W){
      score.player += 1;
      reset(true);
    }

    // IA simple: perseguir la bola con límite de velocidad
    const aiCenter = aiY + paddleH/2;
    const targetY = ballY + ballSize/2 - paddleH/2;
    const diff = targetY - aiY;
    const maxMove = aiSpeed * dt;
    if(Math.abs(diff) > maxMove) aiY += Math.sign(diff) * maxMove;
    else aiY = targetY;
    aiY = clampPaddle(aiY);

    render();
    rafId = requestAnimationFrame(stepGame);
  }

  // API pública del juego
  window.Game = {
    start(){
      if(running) return;
      running = true;
      lastTime = 0;
      if(!rafId) rafId = requestAnimationFrame(stepGame);
    },
    stop(){
      running = false;
      if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
    },
    togglePause(){
      running = !running;
      if(running && !rafId) rafId = requestAnimationFrame(stepGame);
    },
    restart(){
      score = { player:0, ai:0 };
      reset();
      running = true;
      lastTime = 0;
      if(!rafId) rafId = requestAnimationFrame(stepGame);
    },
    handleWheel(deltaSteps){
      // deltaSteps positivo -> sentido reloj -> mover paleta hacia abajo
      // cada "paso" mueve la paleta N pixeles
      const movePerStep = 8; // alto para respuesta rápida
      playerY = clampPaddle(playerY + (-deltaSteps) * movePerStep); // invertir según UX: rueda horario baja menú -> aquí invertimos para que coincida con intuición
      // para evitar saltos extra, forzamos render inmediato si está en pausa
      if(!running){ render(); }
    },
    // permite consulta externa
    get running(){ return running; },
    get score(){ return score; }
  };

  // botones del HUD
  document.getElementById('gameRestart').addEventListener('click', ()=> window.Game.restart());
  document.getElementById('gamePause').addEventListener('click', ()=> { window.Game.togglePause(); document.getElementById('gamePause').textContent = window.Game.running ? 'Pausa' : 'Reanudar'; });

  // iniciar en estado detenido hasta que el usuario entre a la página
  reset();
  render();
})();

/* ===== Control adicional: al entrar/salir de la página juegos ===== */
window.addEventListener('visibilitychange', ()=> {
  if(document.hidden && window.Game && window.Game.running) window.Game.stop();
});

/* ===== Botón físico OK también controla juego (ya definido arriba) ===== */
/* Fin del script */
</script>
</body>
</html>
