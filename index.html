<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>iPod Classic - Rueda funcional + scroll + Juegos</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:#000000;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#fff;-webkit-font-smoothing:antialiased}
  a{color:inherit;text-decoration:none}
  .ipod-wrap{width:420px;max-width:94vw;margin:20px auto;padding:16px;
    background:linear-gradient(150deg, #b2b3b4 0%, #d1d2d3 30%, #a7a8a9 70%, #8f9091 100%);;
    border-radius:28px;box-shadow:0 30px 60px rgba(0,0,0,.6), inset 0 6px 20px rgba(255,255,255,.02);
    border:2px solid rgba(255,255,255,.03)}
  .screen{height:300px;background:#000;border-radius:12px;overflow:hidden;position:relative;
    box-shadow:inset 0 14px 40px rgba(0,0,0,.6), 0 10px 30px rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.02)}
  .header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;font-weight:600;font-size:13px;color:#e6e6e6;z-index:3}
  .header .title{font-weight:700}
  .header .icons{font-size:12px;color:#bdbdbd}
  .header .icons{display:flex;align-items:center;gap:10px;color:#cfdde6}
  .signal{display:flex;align-items:flex-end;gap:3px;height:12px}
  .signal span{width:3px;border-radius:2px;background:rgba(255,255,255,0.22);transition:background .18s,opacity .18s}
  .signal span.bar1{height:5px}
  .signal span.bar2{height:7px}
  .signal span.bar3{height:9px}
  .signal span.bar4{height:11px}
  .signal span.active{background:#cfdde6;opacity:1}
  .battery{position:relative;width:24px;height:12px;border:1px solid #cfdde6;border-radius:2px;overflow:hidden}
  .battery::after{content:"";Position:absolute;top:3px;right:-3px;width:2px;height:6px;background:#cfdde6;border-radius:1px}
  .battery-level {height:100%;width:100%;background:#4caf50;border-radius:1px;transition:width 1s ease, background 1s ease;}
  .battery.charging .battery-level{animation:batt-pulse 1s infinite}
  @keyframes batt-pulse{0%{opacity:.85}50%{opacity:1}100%{opacity:.85}}
  .content{position:relative;height:calc(100% - 42px);display:flex;background:linear-gradient(180deg,#061220 0%, #0b1720 100%)}
  .leftPane{
    width:56%;min-width:140px;padding:14px;display:flex;flex-direction:column;justify-content:center;align-items:center;
    background-size:cover;background-position:center;position:relative;transition:width .36s cubic-bezier(.2,.9,.3,1),opacity .36s;
    border-right:1px solid rgba(255,255,255,.02);
    overflow:hidden;
  }
  .leftPane.hidden{width:5%;opacity:.38;padding:8px 6px;min-width:54px}
  .leftOverlay{position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.75));z-index:1}
  .artistAvatar{width:110px;height:110px;border-radius:10px;object-fit:cover;z-index:2;box-shadow:0 12px 30px rgba(0,0,0,.6)}
  .nowInfo{width:92%;position:relative;z-index:2;margin-top:12px;text-align:center}
  .nowInfo .title{font-weight:800;font-size:16px;color:#fff}
  .nowInfo .artist{font-size:12px;color:#d7e6ef;margin-top:4px}
  .bigProgress{width:92%;height:8px;background:rgba(255,255,255,.06);border-radius:10px;margin-top:10px;overflow:hidden;z-index:2}
  .bigProgress .bar{height:100%;width:0%;background:linear-gradient(90deg,#6aff80,#03742d);transition:width .12s linear}
  .rightPane{width:44%;padding:12px;display:flex;flex-direction:column;gap:8px;justify-content:flex-start;align-items:flex-start;overflow:auto;transition:width .36s cubic-bezier(.2,.9,.3,1)}
  .rightPane.full{width:95%}
  .menu{list-style:none;padding:8px 6px;width:100%;color:#fff;overflow:auto}
  .menu li{padding:10px 12px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.02));
    display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:transform .12s,background .12s;outline:none}
  .menu li:focus{box-shadow:0 0 0 3px rgba(26,140,255,.12)}
  .menu li:hover{transform:translateX(4px)}
  .menu li.selected{background: linear-gradient(180deg, #e1dd90, #333232);transform:translateX(6px);color:#012;font-weight:700}
  .menu li .subtitle{font-size:12px;color:rgba(255,255,255,.7)}
  .page{display:none;padding:6px;height:100%;overflow:auto; -webkit-overflow-scrolling: touch;}
  .page.active{display:block;animation:fadeIn .24s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .bio .avatar{width:100%;height:160px;border-radius:10px;object-fit:cover;margin-bottom:12px}
  .bio h3{margin-bottom:8px}
  .bio p{color:#e9eef2;line-height:1.5;font-size:14px}
  .nowPlaying{display:flex;flex-direction:column;align-items:center;gap:12px;padding:6px;height:100%;justify-content:flex-start}
  .nowPlaying .art{width:60%;max-width:320px;height:auto;border-radius:12px;box-shadow:0 18px 40px rgba(0,0,0,.7)}
  .nowPlaying .meta{width:90%;text-align:center}
  .nowPlaying .meta .song{font-weight:800;font-size:18px}
  .nowPlaying .meta .artist{font-size:13px;color:#cfdde6;margin-top:6px}
  .timeRow{width:90%;Display:flex;justify-content:space-between;font-size:12px;color:#bfcfd6;margin-top:6px}
  .timeRowSmall {width: 92%;display: flex;justify-content: space-between;font-size: 11px;color: #bfcfd6;margin: 6px 0 4px 0; z-index: 2;}
  .tracks{width:100%;margin-top:8px}
  .track{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,.03);margin-bottom:8px;cursor:pointer}
  .track:hover{background:rgba(255,255,255,.05)}
  .track button{background:linear-gradient(180deg,#1db954,#17a44a);border:none;padding:6px 10px;border-radius:6px;color:#022;font-weight:700;cursor:pointer}
  .galleryGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .galleryGrid img{width:100%;height:110px;object-fit:cover;border-radius:8px;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,.5);transition:transform .25s}
  .galleryGrid img:hover{transform:scale(1.02)}
  .socials{display:flex;flex-direction:column;gap:8px}
  .socials a{padding:10px;border-radius:8px;background:rgba(255,255,255,.03);color:#fff;display:flex;align-items:center;gap:8px;cursor:pointer}
  .controls{display:flex;justify-content:center;padding:14px}
  .wheel{
    position: relative;
    width: 240px;
    height: 240px;
    background: #f3f3f0;
    border-radius: 50%;
    box-shadow:
      0 4px 8px rgba(0,0,0,0.45),
      inset 0 1px 2px rgba(255,255,255,0.5),
      inset 0 -2px 4px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .wheel button {
    position: absolute;
    background: none;
    border: none;
    color: #777;
    cursor: pointer;
    font-weight: 600;
    user-select: none;
    transition: transform .1s ease, color .15s ease;
  }
  .wheel button:active { transform: scale(.95); color: #333; }

  .wheel .btn-menu{top:8%;left:50%;transform:translateX(-50%);font-size:13px}
  .wheel .center{
    width:96px;height:96px;border-radius:50%;
    background:#a6a7a8;
    box-shadow:inset 0 1px 2px rgba(255,255,255,0.5),inset 0 -2px 4px rgba(0,0,0,0.25);
  }

  .wheel .btn-prev,
  .wheel .btn-next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 44px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1px;
    background: none;
    border: none;
    cursor: pointer;
    color: #777;
  }

  /* ubicación */
  .wheel .btn-prev { left: 5%; }
  .wheel .btn-next { right: 5%; }

  /* barra vertical (elemento <span class="bar">) */
  .wheel .btn-prev .bar,
  .wheel .btn-next .bar {
    display: inline-block;
    width: 2px;
    height: 12px;
    background: #777;
    border-radius: 1px;
  }

  /* triángulos (flechas) como spans — izquierdo y derecho */
  .wheel .tri {
    display: inline-block;
    width: 0;
    height: 0;
    border-style: solid;
  }

  /* triángulo apuntando a la izquierda (◀) */
  .wheel .tri-left {
    border-width: 6px 7px 6px 0;
    border-color: transparent #777 transparent transparent;
    margin: 0 1px;
  }

  /* triángulo apuntando a la derecha (▶) */
  .wheel .tri-right {
    border-width: 6px 0 6px 7px;
    border-color: transparent transparent transparent #777;
    margin: 0 1px;
  }

  /* Orden y separación exacta:
    - Prev: barra (left) + tri + tri
    - Next: tri + tri + barra (right)
    ya vienen así por el HTML que te pedí.
  */

  /* Visual tweak para que no queden pegados*/
  .wheel .btn-prev .tri-left + .tri-left { margin-left: 0; margin-right: 2px; }
  .wheel .btn-next .tri-right + .tri-right { margin-right: 0; margin-left: 2px; }

  /* interacción: hover / active */
  .wheel .btn-prev:hover .bar,
  .wheel .btn-next:hover .bar,
  .wheel .btn-prev:hover .tri,
  .wheel .btn-next:hover .tri {
    background: #444; /* tint más oscuro en hover (triángulos usan border-color, cambiamos con filter) */
    filter: brightness(0.9);
  }

  /* active (presionado): leve hundimiento */
  .wheel .btn-prev:active,
  .wheel .btn-next:active {
    transform: translateY(-50%) scale(.95);
  }

  /* Play/Pause (CSS puro) */
  .wheel .btn-play{
    bottom:8%;left:50%;transform:translateX(-50%);
    display:flex;align-items:center;justify-content:center;
  }
  .wheel .btn-play::before{
    content:"";
    border-style:solid;
    border-width:6px 0 6px 9px;
    border-color:transparent transparent transparent #777;
    display:inline-block;
    margin-right:3px;
  }
  .wheel .btn-play::after{
    content:"";
    display:inline-block;
    width:3px;height:10px;background:#777;
    box-shadow:4px 0 0 #777;
  }
  .photoModal{position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:60;opacity:0;pointer-events:none;transition:opacity .28s ease}
  .photoModal.open{opacity:1;pointer-events:auto}
  .photoModal .photoFrame{width:92%;height:82%;max-width:760px;max-height:520px;border-radius:12px;overflow:hidden;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative}
  .photoModal img{width:100%;height:100%;object-fit:contain;background:#000}
  .photoModal .thumbs{height:70px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.04));display:flex;gap:8px;padding:8px;overflow:auto}
  .photoModal .thumbs img{height:54px;border-radius:6px;cursor:pointer;opacity:.9;border:2px solid transparent}
  .photoModal .thumbs img.active{border-color:#2aa6ff;opacity:1}
  .photoModal .closeBtn,
  .photoModal .navBtn {position:absolute;width:44px;height:44px;border-radius:50%;background:rgba(30,30,30,0.65);backdrop-filter:blur(6px);color:#fff;border:none;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;transition:all 0.25s ease;box-shadow:0 4px 12px rgba(0,0,0,0.4);z-index:10;}
  .photoModal .closeBtn:hover, .photoModal .navBtn:hover { background:rgba(255,255,255,0.9);color:#111;transform:scale(1.1); }
  .photoModal .closeBtn {top:20px;right:20px;font-size:20px;}
  .photoModal .navBtn.navPrev {left:20px;top:50%;transform:translateY(-50%); font-size: 40px;}
  .photoModal .navBtn.navNext { right:20px;top:50%;transform:translateY(-50%);font-size: 40px;}
  button, .menu li, .track, .galleryGrid img, .wheel .center, .wheel .btn-menu, .wheel .btn-prev, .wheel .btn-next, .wheel .btn-play, .socials a{cursor:pointer}
  .rightPane::-webkit-scrollbar, .menu::-webkit-scrollbar, .page::-webkit-scrollbar, .photoModal .thumbs::-webkit-scrollbar {height:8px;width:8px}
  .rightPane::-webkit-scrollbar-thumb, .menu::-webkit-scrollbar-thumb, .page::-webkit-scrollbar-thumb, .photoModal .thumbs::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,.08); border-radius:8px;
  }
  .rightPane::-webkit-scrollbar-track, .menu::-webkit-scrollbar-track, .page::-webkit-scrollbar-track, .photoModal .thumbs::-webkit-scrollbar-track {
    background: transparent;
  }
  .rightPane, .menu, .page { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.08) transparent; }
  .no-transition * { transition: none !important; }
  #playingArt {width: 60%;max-width: 320px;aspect-ratio: 1 / 1;background: rgba(255,255,255,.05);object-fit: cover;border-radius: 12px; display: block;}
  #nowPlaying { min-height: 280px;}
  /* estilos para la página de juegos */
  .game-canvas { width: 100%; height: 100%; background: linear-gradient(180deg,#031022,#051430); border-radius:10px; display:block; }
  .game-hud { display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#cfe8ff;padding:6px 4px }
  .game-controls { display:flex;gap:6px;align-items:center }
  .smallBtn { padding:6px 8px;border-radius:6px;background:rgba(255,255,255,.03);border:none;color:#fff }
  @media (max-width: 768px) {
    body {
      overflow-y: hidden; /* bloquea scroll vertical */
      height: 100vh;      /* asegura que no se expanda */
    }
  }

</style>
</head>
<body>
  <div class="ipod-wrap" role="application" aria-label="iPod Portfolio final">
    <div class="screen" id="screen">
      <div class="header">
        <div class="title" id="headerTitle">9:41 AM • Music</div>
        <div class="icons">
          <div class="signal" id="signalIcon"><span class="bar1"></span><span class="bar2"></span><span class="bar3"></span><span class="bar4"></span></div>
          <div class="battery" id="batteryWrap"><div class="battery-level" id="batteryLevel"></div></div>
        </div>
      </div>

      <div class="content" id="content">
        <!-- LEFT -->
        <div class="leftPane" id="leftPane">
          <div class="leftOverlay" aria-hidden="true"></div>
          <img id="artistAvatar" class="artistAvatar" src="" alt="Artista">
          <div class="nowInfo" aria-live="polite">
            <div class="title" id="nowTitle">Nombre del Tema</div>
            <div class="artist" id="nowArtist">Nombre del Artista</div>
            <div class="timeRowSmall">
              <div id="leftTimeCurrent">0:00</div>
              <div id="leftTimeTotal">0:00</div>
            </div>
            <div class="bigProgress">
              <div class="bar" id="bigBar" style="width:0%"></div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="rightPane" id="rightPane">
          <ul id="menuList" class="menu" role="menu" aria-label="Menu principal"></ul>

          <div id="page-bio" class="page" role="document" aria-hidden="true">
            <h3>Biografía</h3>
            <img src="img/main.webp" alt="Foto artista" class="avatar" style="width:100%;height:160px;object-fit:cover;border-radius:10px;margin-bottom:10px">
            <div class="bio">
              <p><strong>Sebastián Yepes</strong> — Sebastián Yepes Alzate músico colombiano, nacido en la ciudad de Manizales Departamento de Caldas en el eje cafetero Colombiano, el 10 de junio de 1980. Ex-vocalista de la agrupación Sanalejo.</p>
            </div>
          </div>

          <div id="page-music" class="page" role="document" aria-hidden="true">
            <div class="nowPlaying" id="nowPlaying">
              <img src="" class="art" id="playingArt" alt="Carátula">
              <div class="meta">
                <div class="song" id="playingTitle">Track One</div>
                <div class="artist" id="playingArtist">Nombre del Artista</div>
                <div class="timeRow">
                  <div id="timeCurrent">0:00</div>
                  <div id="timeTotal">0:00</div>
                </div>
                <div class="bigProgress" style="margin-top:8px"><div class="bar" id="mainBar" style="width:0%"></div></div>
              </div>

              <div class="tracks" id="tracksList" aria-label="Lista de pistas"></div>
            </div>
            <audio id="player" preload="metadata"></audio>
          </div>

          <div id="page-photos" class="page" role="document" aria-hidden="true">
            <h3>Fotos</h3>
            <div class="galleryGrid" id="galleryGrid" aria-label="Galería"></div>
          </div>

          <div id="page-social" class="page" role="document" aria-hidden="true">
            <h3>Redes</h3>
            <div class="socials">
              <a href="https://instagram.com" target="_blank" rel="noopener noreferrer">📸 Instagram</a>
              <a href="https://facebook.com" target="_blank" rel="noopener noreferrer">📘 Facebook</a>
            </div>
          </div>

          <!-- Página nueva: Juegos -->
          <div id="page-games" class="page" role="document" aria-hidden="true" style="position:relative;">
            <div class="game-hud">
              <div>JUEGOS</div>
              <div class="game-controls">
                <button id="gameRestart" class="smallBtn">Reiniciar</button>
                <button id="gamePause" class="smallBtn">Pausa</button>
              </div>
            </div>
            <div id="gameCountdown"
              style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
                      font-size:48px;font-weight:bold;color:#fff;
                      text-shadow:2px 2px 6px #000;display:none;z-index:99;">
            </div>
            <canvas id="gameCanvas" class="game-canvas" width="320" height="240" aria-label="Canvas de juego"></canvas>
            <div id="gameOver" style="display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;text-align:center;z-index:200;">
              <h1 style="font-size:32px;text-shadow:2px 2px 8px red;">PERDISTE</h1>
              <button onclick="window.Game.restart()" 
                      style="padding:8px 16px;font-size:16px;font-weight:bold;background:#0ff;color:#000;border:none;border-radius:6px;cursor:pointer;">
                Reiniciar
              </button>
            </div>
            <div style="height:8px"></div>
            <div style="font-size:12px;color:#cfe8ff;padding:4px">Usa la rueda para mover la paleta. Pulsa OK para iniciar/pausar.</div>
          </div>

        </div>
      </div>
    </div>

    <!-- Wheel -->
    <div class="controls">
      <div class="wheel" id="wheel">
        <button class="btn-menu tiny" id="btn-menu">MENU</button>
        <button class="btn-prev tiny" id="btn-prev" aria-label="Anterior">
          <span class="bar"></span>
          <span class="tri tri-left"></span>
          <span class="tri tri-left"></span>
        </button>

        <button class="btn-next tiny" id="btn-next" aria-label="Siguiente">
          <span class="tri tri-right"></span>
          <span class="tri tri-right"></span>
          <span class="bar"></span>
        </button>

        <button class="center" id="btn-select"></button>
        <button class="btn-play tiny" id="btn-play"></button>
      </div>
    </div>

  <!-- Photo modal -->
  <div class="photoModal" id="photoModal" aria-hidden="true" role="dialog" aria-label="Foto ampliada">
    <div class="photoFrame" role="document">
      <button class="closeBtn" id="photoClose" aria-label="Cerrar foto">✕</button>
      <button class="navBtn navPrev" id="photoPrev" aria-label="Anterior foto">◂</button>
      <button class="navBtn navNext" id="photoNext" aria-label="Siguiente foto">▸</button>
      <img id="modalImg" alt="Foto ampliada">
      <div class="thumbs" id="photoThumbs" aria-hidden="false"></div>
    </div>
  </div>

<script>
/* ===== Datos ===== */
const DATA = {
  artist: {
    name: 'Sebastián Yepes',
    cover: 'https://picsum.photos/900/900?random=15',
    avatar: 'img/artist.webp'
  },
  menu:[
    { id:'bio', label:'Biografía', subtitle:'Sobre el artista' },
    { id:'music', label:'Música', subtitle:'Pistas & demos' },
    { id:'photos', label:'Fotos', subtitle:'Galería visual' },
    { id:'social', label:'Redes', subtitle:'Instagram / Facebook' },
    { id:'games', label:'Juegos', subtitle:'Naves (rueda)' } // nuevo elemento
  ],
  tracks:[
    { title:'No me veré caer', src:'assets/track1.mp3', length:'3:22', art:'img/track1.webp' },
    { title:'Track Two', src:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3', length:'4:02', art:'https://picsum.photos/600/600?random=14' },
    { title:'Ambient Demo', src:'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3', length:'2:48', art:'https://picsum.photos/600/600?random=16' }
  ],
  gallery:[
    'img/pic1.webp',
    'img/pic2.webp',
    'img/pic3.webp',
    'img/pic4.webp'
  ]
};

/* ===== Referencias DOM ===== */
const leftPane = document.getElementById('leftPane');
const artistAvatar = document.getElementById('artistAvatar');
const nowTitle = document.getElementById('nowTitle');
const nowArtist = document.getElementById('nowArtist');
const bigBar = document.getElementById('bigBar');

const leftTimeCurrent = document.getElementById('leftTimeCurrent');
const leftTimeTotal = document.getElementById('leftTimeTotal');

const menuList = document.getElementById('menuList');
const pages = {
  bio: document.getElementById('page-bio'),
  music: document.getElementById('page-music'),
  photos: document.getElementById('page-photos'),
  social: document.getElementById('page-social'),
  games: document.getElementById('page-games') // nueva página
};

const tracksList = document.getElementById('tracksList');
const galleryGrid = document.getElementById('galleryGrid');

const player = document.getElementById('player');
const playingArt = document.getElementById('playingArt');
const playingTitle = document.getElementById('playingTitle');
const playingArtist = document.getElementById('playingArtist');
const mainBar = document.getElementById('mainBar');
const timeCurrent = document.getElementById('timeCurrent');
const timeTotal = document.getElementById('timeTotal');

const btnSelect = document.getElementById('btn-select');
const btnMenu = document.getElementById('btn-menu');
const btnPrev = document.getElementById('btn-prev');
const btnNext = document.getElementById('btn-next');
const btnPlay = document.getElementById('btn-play');

const photoModal = document.getElementById('photoModal');
const modalImg = document.getElementById('modalImg');
const photoThumbs = document.getElementById('photoThumbs');
const photoClose = document.getElementById('photoClose');
const photoPrev = document.getElementById('photoPrev');
const photoNext = document.getElementById('photoNext');

const wheel = document.getElementById('wheel');

/* ===== Estado global ===== */
let currentMenuIndex = 0;
let inPage = false;
let currentPageId = null;
let currentTrackIndex = 0;
let currentPhotoIndex = 0;

/* ===== MSE globals (sin cambios) ===== */
let currentMSE = { mediaSource: null, sourceBuffer: null, objectUrl: null, fetchController: null, queue: [], isUsingMSE: false };

/* ===== Util helpers ===== */
function isInsideButton(target){ return !!target.closest('button'); }
function scrollActivePage(steps, direction){
  if(!inPage || !currentPageId) return;
  const active = pages[currentPageId];
  if(!active) return;
  const amount = 80 * steps * direction;
  const maxScroll = active.scrollHeight - active.clientHeight;
  const desired = active.scrollTop + amount;
  const clamped = Math.max(0, Math.min(maxScroll, desired));
  active.scrollTo({top: clamped, behavior: 'smooth'});
}

/* ===== Inicialización UI ===== */
function initArtist(){
  leftPane.style.backgroundImage = `url('${DATA.artist.cover}')`;
  artistAvatar.src = DATA.artist.avatar;
  nowArtist.textContent = DATA.artist.name;
}
function renderMenu(){
  menuList.innerHTML = '';
  DATA.menu.forEach((m,i)=>{
    const li = document.createElement('li');
    li.tabIndex = 0;
    li.dataset.id = m.id;
    li.setAttribute('role','menuitem');
    if(i===currentMenuIndex){
      li.className = 'selected';
      setTimeout(()=> li.scrollIntoView({block:'nearest', behavior:'smooth'}), 0);
    }
    li.innerHTML = `<div><div style="font-size:14px">${m.label}</div><div class="subtitle">${m.subtitle}</div></div><div>›</div>`;
    li.addEventListener('click', ()=> { activateMenuIndex(i); });
    li.addEventListener('keydown', (e)=>{ if(e.key==='Enter') activateMenuIndex(i); });
    menuList.appendChild(li);
  });
}


/* muestra/oculta páginas */
function showPage(id){
  const rightPane = document.getElementById('rightPane');

  if(!id){
    inPage = false;
    currentPageId = null;
    leftPane.classList.remove('hidden');
    rightPane.classList.remove('full');
    Object.values(pages).forEach(p => { 
      p.classList.remove('active'); 
      p.setAttribute('aria-hidden','true'); 
    });
    menuList.style.display = 'block';
    setTimeout(()=> renderMenu(), 160);
    // si veníamos de juegos, detener juego
    if(window.Game && window.Game.running) window.Game.stop();
    return;
  }

  inPage = true;
  currentPageId = id;

  document.body.classList.add("no-transition");

  menuList.style.display = 'none';
  leftPane.classList.add('hidden');
  rightPane.classList.add('full');

  rightPane.style.width = "95%";
  leftPane.style.width = "5%";
  rightPane.offsetHeight;

  requestAnimationFrame(()=>{
    document.body.classList.remove("no-transition");
    rightPane.style.width = "";
    leftPane.style.width = "";
  });

  Object.values(pages).forEach(p => { 
    p.classList.remove('active'); 
    p.setAttribute('aria-hidden','true'); 
  });
  pages[id].classList.add('active');
  pages[id].setAttribute('aria-hidden','false');

  requestAnimationFrame(()=> {
    pages[id].scrollTop = 0;
    if(id === 'music'){ openMusic(); }
    if(id === 'photos'){ populateGallery(); }
    if (id === 'games') {
      if (window.Game) {
        window.Game.stop();            // asegurar detenido
        if (window.Game.startCountdown) window.Game.startCountdown();
      }
    }

  });
}

function activateMenuIndex(i){
  currentMenuIndex = i;
  renderMenu();
  showPage(DATA.menu[i].id);
}

/* ===== Tracks & Now Playing ===== */
function populateTracks(){
  tracksList.innerHTML = '';
  DATA.tracks.forEach((t,i) => {
    const div = document.createElement('div');
    div.className = 'track';
    div.tabIndex = 0;
    div.innerHTML = `<div><strong>${t.title}</strong><div style="font-size:12px;color:#cfd8dc">${t.length}</div></div><div><button aria-label="Reproducir ${t.title}">Play</button></div>`;
    div.querySelector('button').addEventListener('click', (ev) => { ev.stopPropagation(); playTrack(i); });
    div.addEventListener('click', ()=> playTrack(i));
    div.addEventListener('keydown', (e)=>{ if(e.key==='Enter') playTrack(i); });
    tracksList.appendChild(div);
  });
}

function playTrack(i){
  if(i < 0 || i >= DATA.tracks.length) return;
  if(i === currentTrackIndex && player.src && player.paused){
    player.play().catch(()=>{});
    return;
  }
  cleanupCurrentMSE();
  currentTrackIndex = i;
  const t = DATA.tracks[i];
  loadTrackWithMSE(t.src).then((usedMSE) => {
    if(!usedMSE){
      player.src = t.src;
      player.preload = 'auto';
      player.play().catch(()=>{});
    }
  }).catch((err)=>{
    player.src = t.src;
    player.preload = 'auto';
    player.play().catch(()=>{});
  });
  updateNowPlayingUI(t);
}

function updateNowPlayingUI(t){
  playingTitle.textContent = t.title;
  playingArtist.textContent = DATA.artist.name;
  playingArt.src = t.art || DATA.artist.avatar || "img/placeholder.png";
  nowTitle.textContent = t.title;
  nowArtist.textContent = DATA.artist.name;
  leftPane.style.backgroundImage = `url('${t.art || DATA.artist.cover}')`;
}

function openMusic(){
  populateTracks();
  if(!player.src){
    currentTrackIndex = 0;
    const first = DATA.tracks[0];
    player.src = first.src;
    player.preload = "metadata";
    player.pause();
    playingArt.src = first.art || DATA.artist.avatar;
    playingTitle.textContent = first.title;
    playingArtist.textContent = DATA.artist.name;
    nowTitle.textContent = first.title;
    nowArtist.textContent = DATA.artist.name;
    leftPane.style.backgroundImage = `url('${first.art || DATA.artist.cover}')`;
  }
}

/* ========== MSE (sin cambios funcionales importantes) ========== */
async function loadTrackWithMSE(url){
  if(!('MediaSource' in window)) return false;
  try{
    const headResp = await fetch(url, { method: 'HEAD' });
    const acceptRanges = headResp.headers.get('accept-ranges') || '';
    const contentLengthHeader = headResp.headers.get('content-length');
    const contentLength = contentLengthHeader ? parseInt(contentLengthHeader, 10) : NaN;
    const supportsRange = acceptRanges.toLowerCase().includes('bytes');
    if(!supportsRange || isNaN(contentLength)) return false;
    const mime = 'audio/mpeg';
    const mediaSource = new MediaSource();
    currentMSE.mediaSource = mediaSource;
    currentMSE.queue = [];
    currentMSE.fetchController = new AbortController();
    currentMSE.isUsingMSE = true;
    const objectUrl = URL.createObjectURL(mediaSource);
    currentMSE.objectUrl = objectUrl;
    player.src = objectUrl;
    await new Promise((resolve, reject) => {
      const onSourceOpen = () => {
        try{
          const sb = mediaSource.addSourceBuffer(mime);
          currentMSE.sourceBuffer = sb;
          resolve();
        }catch(err){ reject(err); }
        finally { mediaSource.removeEventListener('sourceopen', onSourceOpen); }
      };
      mediaSource.addEventListener('sourceopen', onSourceOpen);
      setTimeout(()=> {
        if(mediaSource.readyState !== 'open') reject(new Error('MediaSource open timeout'));
      }, 5000);
    });
    const chunkSize = 64 * 1024;
    let start = 0;
    const total = contentLength;
    const sb = currentMSE.sourceBuffer;
    function appendBufferChunk(ab){
      if(!sb) return;
      if(sb.updating) currentMSE.queue.push(ab);
      else sb.appendBuffer(ab);
    }
    sb.addEventListener('updateend', ()=>{
      if(currentMSE.queue.length){
        const next = currentMSE.queue.shift();
        try{ sb.appendBuffer(next); } catch(e){ console.error(e); }
      }
    });
    const controller = currentMSE.fetchController;
    const signal = controller.signal;
    let appendedFirstChunk = false;
    while(start < total){
      if(signal.aborted) throw new Error('aborted');
      const end = Math.min(start + chunkSize - 1, total - 1);
      const rangeHeader = `bytes=${start}-${end}`;
      const resp = await fetch(url, { headers: { Range: rangeHeader }, signal });
      if(!resp.ok && resp.status !== 206) throw new Error('Range request failed with status ' + resp.status);
      const arrayBuffer = await resp.arrayBuffer();
      appendBufferChunk(arrayBuffer);
      if(!appendedFirstChunk){
        appendedFirstChunk = true;
        player.play().catch(()=>{});
      }
      start += chunkSize;
    }
    const waitForAllAppended = () => new Promise((resolve) => {
      const check = () => {
        if(!sb.updating && currentMSE.queue.length === 0) resolve();
        else setTimeout(check, 50);
      };
      check();
    });
    await waitForAllAppended();
    try{ if(currentMSE.mediaSource && currentMSE.mediaSource.readyState === 'open'){ currentMSE.mediaSource.endOfStream(); } }catch(e){}
    return true;
  }catch(err){
    cleanupCurrentMSE();
    console.warn('MSE pipeline error', err);
    return false;
  }
}

function cleanupCurrentMSE(){
  try{ if(currentMSE.fetchController) currentMSE.fetchController.abort(); }catch(e){}
  try{
    if(currentMSE.sourceBuffer && currentMSE.mediaSource && currentMSE.mediaSource.readyState === 'open'){
      try{ currentMSE.mediaSource.removeSourceBuffer(currentMSE.sourceBuffer); } catch(e){}
    }
  }catch(e){}
  try{ if(currentMSE.objectUrl) URL.revokeObjectURL(currentMSE.objectUrl); }catch(e){}
  currentMSE = { mediaSource: null, sourceBuffer: null, objectUrl: null, fetchController: null, queue: [], isUsingMSE: false };
}

/* player events */
player.addEventListener('loadedmetadata', ()=> { 
  if(timeTotal) timeTotal.textContent = formatTime(player.duration || 0);
  if(leftTimeTotal) leftTimeTotal.textContent = formatTime(player.duration || 0);
});
player.addEventListener('timeupdate', ()=> {
  if(player.duration && !isNaN(player.duration)){
    const pct = Math.max(0, Math.min(100, (player.currentTime / player.duration) * 100));
    if(mainBar) mainBar.style.width = pct + '%';
    if(bigBar) bigBar.style.width = pct + '%';
    if(timeCurrent) timeCurrent.textContent = formatTime(player.currentTime);
    if(timeTotal) timeTotal.textContent = formatTime(player.duration);
    if(leftTimeCurrent) leftTimeCurrent.textContent = formatTime(player.currentTime);
    if(leftTimeTotal) leftTimeTotal.textContent = formatTime(player.duration);
  }
});
player.addEventListener('ended', ()=> {
  const next = (currentTrackIndex + 1) % DATA.tracks.length;
  playTrack(next);
});
function formatTime(s){ if(!s || isNaN(s)) return '0:00'; const min = Math.floor(s/60); const sec = Math.floor(s%60).toString().padStart(2,'0'); return `${min}:${sec}`; }

/* ===== Gallery & Modal ===== */
function populateGallery(){
  galleryGrid.innerHTML = '';
  DATA.gallery.forEach((url, idx)=>{
    const img = document.createElement('img');
    img.src = url; img.alt = 'Foto artista';
    img.tabIndex = 0;
    img.addEventListener('click', ()=> openPhoto(idx));
    img.addEventListener('keydown', (e)=>{ if(e.key==='Enter') openPhoto(idx); });
    galleryGrid.appendChild(img);
  });
}
function openPhoto(index){
  if(index < 0 || index >= DATA.gallery.length) return;
  currentPhotoIndex = index;
  modalImg.src = DATA.gallery[index];
  photoModal.classList.add('open'); photoModal.setAttribute('aria-hidden','false');
  buildPhotoThumbs(); highlightActiveThumb();
}
function closePhoto(){ photoModal.classList.remove('open'); photoModal.setAttribute('aria-hidden','true'); modalImg.src=''; }
function buildPhotoThumbs(){
  photoThumbs.innerHTML = '';
  DATA.gallery.forEach((u,i)=>{
    const t = document.createElement('img'); t.src = u; t.alt='Miniatura'; t.tabIndex=0;
    t.addEventListener('click', ()=> openPhoto(i)); t.addEventListener('keydown', (e)=>{ if(e.key==='Enter') openPhoto(i); });
    if(i===currentPhotoIndex) t.classList.add('active');
    photoThumbs.appendChild(t);
  });
}
function highlightActiveThumb(){ const thumbs = photoThumbs.querySelectorAll('img'); thumbs.forEach((img,i)=> img.classList.toggle('active', i===currentPhotoIndex)); }

photoPrev.addEventListener('click', ()=> { currentPhotoIndex=(currentPhotoIndex-1+DATA.gallery.length)%DATA.gallery.length; modalImg.src = DATA.gallery[currentPhotoIndex]; highlightActiveThumb(); });
photoNext.addEventListener('click', ()=> { currentPhotoIndex=(currentPhotoIndex+1)%DATA.gallery.length; modalImg.src = DATA.gallery[currentPhotoIndex]; highlightActiveThumb(); });
photoClose.addEventListener('click', closePhoto);
photoModal.addEventListener('click', (e)=> { if(e.target === photoModal) closePhoto(); });
modalImg.addEventListener('click', (e)=> e.stopPropagation());

/* ===== Wheel rotation (entrada para la rueda) ===== */
let tracking=false, lastAngle=null, accumulator=0;
const THRESH = 18; // sensibilidad de cada "paso"

/* calcula ángulo desde evento */
function angleFromEvent(e){
  const rect = wheel.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top + rect.height/2;
  const ev = (e.touches && e.touches[0]) ? e.touches[0] : e;
  const x = ev.clientX - cx;
  const y = ev.clientY - cy;
  return Math.atan2(y, x) * 180 / Math.PI;
}

/* procesar pasos detectados por la rueda
   dir: 1 => sentido horario (bajar), -1 => antihorario (subir) */
function step(delta){
  if(delta > 60) delta = 60;
  if(delta < -60) delta = -60;

  accumulator += delta;
  const maxAccum = THRESH * 4;
  if(accumulator > maxAccum) accumulator = maxAccum;
  if(accumulator < -maxAccum) accumulator = -maxAccum;

  if(Math.abs(accumulator) >= THRESH){
    const steps = Math.floor(Math.abs(accumulator) / THRESH);
    const dir = accumulator > 0 ? 1 : -1;
    accumulator = accumulator - dir * steps * THRESH;

    // comportamiento específico si estamos en la página de juegos
    if(inPage && currentPageId === 'games' && window.Game){
      window.Game.handleWheel(dir * steps); // control del juego por la rueda
    } else if(!inPage){
      currentMenuIndex = (currentMenuIndex + dir * steps + DATA.menu.length) % DATA.menu.length;
      renderMenu();
    } else {
      if(currentPageId === 'photos' && photoModal.classList.contains('open')){
        currentPhotoIndex = (currentPhotoIndex + dir * steps + DATA.gallery.length) % DATA.gallery.length;
        modalImg.src = DATA.gallery[currentPhotoIndex];
        highlightActiveThumb();
      } else {
        scrollActivePage(steps, dir);
      }
    }

    if(navigator.vibrate) navigator.vibrate(6);
  }
}

/* eventos de puntero/táctil para la rueda */
wheel.addEventListener('pointerdown', (e)=>{
  if(isInsideButton(e.target)) return;
  tracking = true;
  lastAngle = angleFromEvent(e);
  try{ wheel.setPointerCapture && wheel.setPointerCapture(e.pointerId); }catch(err){}
});
wheel.addEventListener('pointermove', (e)=>{
  if(!tracking) return;
  const a = angleFromEvent(e);
  let delta = a - lastAngle;
  if(delta > 180) delta -= 360;
  if(delta < -180) delta += 360;
  lastAngle = a;
  if(delta > 60) delta = 60;
  if(delta < -60) delta = -60;
  step(delta);
});
wheel.addEventListener('pointerup', (e)=>{
  tracking=false; lastAngle=null; accumulator=0;
  try{ wheel.releasePointerCapture && wheel.releasePointerCapture(e.pointerId); }catch(err){}
});
wheel.addEventListener('touchstart', (e)=>{
  if(isInsideButton(e.target)) return;
  tracking=true; lastAngle = angleFromEvent(e);
}, {passive:false});
wheel.addEventListener('touchmove', (e)=>{
  if(!tracking) return;
  const a = angleFromEvent(e);
  let delta = a - lastAngle;
  if(delta > 180) delta -= 360;
  if(delta < -180) delta += 360;
  lastAngle = a;
  if(delta > 60) delta = 60;
  if(delta < -60) delta = -60;
  step(delta);
  e.preventDefault();
}, {passive:false});
wheel.addEventListener('touchend', ()=>{ tracking=false; lastAngle=null; accumulator=0; });

/* ===== Botones de la rueda ===== */
function safePlayToggle(){
  if(!player.src) { playTrack(0); return; }
  if(player.paused) { player.play().catch(()=>{}); }
  else { player.pause(); }
}

document.getElementById('btn-select').addEventListener('click', ()=>{
  if(!inPage){
    const id = DATA.menu[currentMenuIndex].id;
    showPage(id);
  } else {
    if(currentPageId === 'music') safePlayToggle();
    else if(currentPageId === 'photos') openPhoto(0);
    else if(currentPageId === 'games' && window.Game) window.Game.togglePause();
  }
});
document.getElementById('btn-menu').addEventListener('click', ()=>{
  if(inPage) showPage(null);
  else { currentMenuIndex = 0; renderMenu(); }
});
document.getElementById('btn-prev').addEventListener('click', ()=>{
  if(!inPage){
    const prev = (currentTrackIndex - 1 + DATA.tracks.length) % DATA.tracks.length;
    playTrack(prev);
  } else if(currentPageId === 'music'){
    const prev = (currentTrackIndex - 1 + DATA.tracks.length) % DATA.tracks.length; playTrack(prev);
  } else if(currentPageId === 'photos'){
    if(photoModal.classList.contains('open')) photoPrev.click(); else openPhoto(DATA.gallery.length - 1);
  } else {
    if(currentPageId) pages[currentPageId].scrollBy({top:-80, behavior:'smooth'});
  }
});
document.getElementById('btn-next').addEventListener('click', ()=>{
  if(!inPage){
    const next = (currentTrackIndex + 1) % DATA.tracks.length;
    playTrack(next);
  } else if(currentPageId === 'music'){
    const next = (currentTrackIndex + 1) % DATA.tracks.length; playTrack(next);
  } else if(currentPageId === 'photos'){
    if(photoModal.classList.contains('open')) photoNext.click(); else openPhoto(0);
  } else {
    if(currentPageId) pages[currentPageId].scrollBy({top:80, behavior:'smooth'});
  }
});
document.getElementById('btn-play').addEventListener('click', ()=> safePlayToggle());

/* ===== Soporte teclado y accesibilidad ===== */
window.addEventListener('keydown', (e)=>{
  if(e.key === 'ArrowUp'){ currentMenuIndex = (currentMenuIndex - 1 + DATA.menu.length) % DATA.menu.length; renderMenu(); }
  if(e.key === 'ArrowDown'){ currentMenuIndex = (currentMenuIndex + 1) % DATA.menu.length; renderMenu(); }
  if(e.key === 'Enter'){ document.getElementById('btn-select').click(); }
  if(e.key === 'Escape'){ document.getElementById('btn-menu').click(); if(photoModal.classList.contains('open')) closePhoto(); }
});

/* Live region accesible */
const live = document.createElement('div');
live.setAttribute('aria-live','polite'); live.style.position='absolute'; live.style.left='-9999px';
document.body.appendChild(live);
const mo = new MutationObserver(()=> live.textContent = DATA.menu[currentMenuIndex].label + ' seleccionado');
mo.observe(menuList,{childList:true,subtree:true});

/* ===== Swipe en páginas para volver al menú (móvil) ===== */
(function enablePageSwipeToLeft(){
  let startX = null, startY = null, trackingSwipe = false;
  const threshold = 50;
  function onStart(e){
    if(!inPage) return;
    const ev = (e.touches && e.touches[0]) ? e.touches[0] : e;
    startX = ev.clientX;
    startY = ev.clientY;
    trackingSwipe = true;
  }
  function onEnd(e){
    if(!trackingSwipe) return;
    const ev = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e;
    const dx = ev.clientX - startX;
    const dy = ev.clientY - startY;
    if(Math.abs(dx) > Math.abs(dy) && dx > threshold){
      showPage(null);
    }
    startX = null; startY = null; trackingSwipe = false;
  }
  Object.values(pages).forEach(p => {
    p.addEventListener('touchstart', onStart, {passive:true});
    p.addEventListener('touchend', onEnd, {passive:true});
    p.addEventListener('pointerdown', (ev)=> { if(ev.pointerType === 'touch') onStart(ev); }, {passive:true});
    p.addEventListener('pointerup', (ev)=> { if(ev.pointerType === 'touch') onEnd(ev); }, {passive:true});
  });
})();

/* ===== Inicializar ===== */
function init(){
  initArtist();
  renderMenu();
  populateTracks();

  currentTrackIndex = 0;
  const first = DATA.tracks[0];
  player.src = first.src;
  player.preload = "metadata";
  player.pause();
  updateNowPlayingUI(first);
  if(bigBar) bigBar.style.width = "0%";
}
init();

/* evitar arrastrar imágenes */
document.addEventListener('dragstart', (e)=>{ if(e.target.tagName === 'IMG') e.preventDefault(); });

/* swipe horizontal extra para mostrar/ocultar leftPane (comportamiento táctil) */
const content = document.getElementById("content");
let startX = 0;
content.addEventListener("touchstart", (e) => { startX = e.touches[0].clientX; }, { passive: true });
content.addEventListener("touchend", (e) => {
  let endX = e.changedTouches[0].clientX;
  let diffX = endX - startX;
  if (diffX > 50 && inPage) {
    const activePage = document.querySelector(".page.active");
    if (activePage) {
      activePage.classList.remove("active");
      document.getElementById("menuList").style.display = "block";
      inPage = false;
    }
  } else if (Math.abs(diffX) > 50 && !inPage) {
    if (diffX > 0) {
      document.getElementById("leftPane").classList.remove("hidden");
      document.getElementById("rightPane").classList.remove("full");
    } else {
      document.getElementById("leftPane").classList.add("hidden");
      document.getElementById("rightPane").classList.add("full");
    }
  }
}, { passive: true });

/* ===== STATUS ICONS (batería + señal) ===== */
(function initStatusIcons(){
  const battLevelEl = document.getElementById('batteryLevel');
  const batteryWrap = document.getElementById('batteryWrap');
  const signalWrap = document.getElementById('signalIcon');

  function setBatteryLevel(p){
    const clamped = Math.max(0, Math.min(1, p));
    battLevelEl.style.width = (clamped*100) + '%';
    let color = '#4caf50';
    if(clamped <= 0.15) color = '#f44336';
    else if(clamped <= 0.35) color = '#ffeb3b';
    battLevelEl.style.background = color;
    batteryWrap.classList.toggle('low', clamped <= 0.15);
  }

  let batteryLevel = 1.0;
  let discharging = true;

  function simulateBattery(){
    if(discharging){
      batteryLevel -= 0.05;
      if(batteryLevel <= 0){ batteryLevel = 0; discharging = false; }
    } else {
      batteryLevel += 0.05;
      if(batteryLevel >= 1){ batteryLevel = 1; discharging = true; }
    }
    setBatteryLevel(batteryLevel);
  }

  setBatteryLevel(batteryLevel);
  setInterval(simulateBattery, 60000);

  function renderSignal(effectiveType){
    const map = { 'slow-2g':1, '2g':1, '3g':2, '4g':4, 'wifi':4, undefined:3 };
    const bars = map[effectiveType] ?? 3;
    const spans = signalWrap.querySelectorAll('span');
    spans.forEach((s, i) => { if(i < bars) s.classList.add('active'); else s.classList.remove('active'); });
  }

  if(navigator.connection && navigator.connection.effectiveType){
    renderSignal(navigator.connection.effectiveType);
    try{ navigator.connection.addEventListener('change', ()=> renderSignal(navigator.connection.effectiveType)); }catch(e){}
  } else {
    renderSignal('4g');
  }
})();

/* ===== Reloj real ===== */
function updateClock() {
  const now = new Date();
  let hours = now.getHours();
  let minutes = now.getMinutes().toString().padStart(2, "0");
  let ampm = hours >= 12 ? "PM" : "AM";
  hours = hours % 12;
  hours = hours ? hours : 12;
  const timeString = `${hours}:${minutes} ${ampm} • Music`;
  document.getElementById("headerTitle").textContent = timeString;
}
updateClock();
setInterval(updateClock, 60000);

(function setupSpaceShooterSprites(){
  const canvas=document.getElementById("gameCanvas");
  const ctx=canvas.getContext("2d",{alpha:false});
  const W=320,H=240;canvas.width=W;canvas.height=H;

  // Cargar sprites
  const sprites={
    player:new Image(),
    enemy1:new Image(),
    enemy2:new Image(),
    laser:new Image(),
    explosion:new Image()
  };
  sprites.player.src="assets/player.png";
  sprites.enemy1.src="assets/enemy1.png";
  sprites.enemy2.src="assets/enemy2.png";
  sprites.laser.src="assets/laser.png";
  sprites.explosion.src="assets/explosion.png";

  // Estado
  let rafId=null,running=false,lastTs=0,score=0;
  const ship={x:56,y:H/2,w:32,h:32};
  let enemies=[],bullets=[],explosions=[],stars=[];

  // Config
  const enemySpawnRate=10.5,enemyMinSpeed=90,enemyMaxSpeed=160,autoShootRate=2;
  const maxEnemies=32;

  // Helpers
  const rand=(a,b)=>Math.random()*(b-a)+a;
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

  function resetGame(){
    enemies=[];bullets=[];explosions=[];
    score=0;ship.y=H/2;
    initStars();
    updateScore();
  }

  // Fondo estrellas
  function initStars(){
    stars.length = 0; // limpiar el array global
    const numStars = 100; 
    for(let i=0; i<numStars; i++){
      stars.push({
        x: Math.random() * W,
        y: Math.random() * H,
        size: Math.random() * 1 + 0.5,      // estrellas más pequeñas (0.5–1.5 px)
        speed: Math.random() * 50 + 20,     // velocidad distinta (px/s)
        alpha: Math.random() * 0.3 + 0.2    // menos brillo (0.2–0.5)
      });
    }
  }

  function drawStars(dt){
    ctx.fillStyle="#000";
    ctx.fillRect(0,0,W,H);

    for(let s of stars){
      ctx.globalAlpha = s.alpha;
      ctx.fillStyle = '#FFFFFF';
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
      ctx.fill();

      // mover la estrella
      s.x -= s.speed * dt;
      if(s.x < 0){
        s.x = W + 2;
        s.y = Math.random() * H;
        s.size = Math.random() * 1 + 0.5;
        s.speed = Math.random() * 50 + 20;
        s.alpha = Math.random() * 0.3 + 0.2;
      }
    }
    ctx.globalAlpha = 1;
  }

  // Naves
  function drawShip(){ctx.drawImage(sprites.player,ship.x-ship.w/2,ship.y-ship.h/2,ship.w,ship.h);}
  function spawnEnemy(){
    if(enemies.length>=maxEnemies) return;
    const img = Math.random()>0.5 ? sprites.enemy1 : sprites.enemy2;
    const vx = -rand(enemyMinSpeed, enemyMaxSpeed);
    const vy = rand(-80, 80); // velocidad vertical aleatoria
    enemies.push({
      x: W+30,
      y: rand(20, H-20),
      w: 32,
      h: 32,
      vx,
      vy,
      img
    });
  }

  function drawEnemies(){for(let e of enemies)ctx.drawImage(e.img,e.x-e.w/2,e.y-e.h/2,e.w,e.h);}

  // Balas
  function shoot(){bullets.push({x:ship.x+16,y:ship.y,vx:220});}
  function drawBullets(){
    for(let b of bullets)ctx.drawImage(sprites.laser, b.x-6, b.y-4, 12, 8);
  }

  // Explosiones
  function pushExplosion(x,y){explosions.push({x,y,life:1});}
  function drawExplosions(dt){
    for(let i=explosions.length-1;i>=0;i--){
      const ex=explosions[i];ex.life-=dt*2;
      if(ex.life<=0){explosions.splice(i,1);continue;}
      const size=32+(1-ex.life)*32;
      ctx.globalAlpha=ex.life;
      ctx.drawImage(sprites.explosion,ex.x-size/2,ex.y-size/2,size,size);
      ctx.globalAlpha=1;
    }
  }

  // HUD
  function updateScore(){const s=document.getElementById("Puntaje");if(s)s.textContent=score;}

  // Loop
  let lastShot=0,spawnAcc=0;
  function update(dt){
    bullets.forEach((b,i)=>{b.x+=b.vx*dt;if(b.x>W+20)bullets.splice(i,1);});
    for(let i=enemies.length-1;i>=0;i--){
      const e = enemies[i];
      e.x += e.vx * dt;
      e.y += e.vy * dt;

      if(e.y < 20 || e.y > H-20){
        e.vy *= -1;
      }
      if(e.x < -30) enemies.splice(i,1);
    }

    // colisión bala-enemigo
    for(let i=enemies.length-1;i>=0;i--){
      for(let j=bullets.length-1;j>=0;j--){
        const e=enemies[i],b=bullets[j];
        if(Math.abs(e.x-b.x)<16&&Math.abs(e.y-b.y)<16){
          pushExplosion(e.x,e.y);
          enemies.splice(i,1);bullets.splice(j,1);
          score++;updateScore();break;
        }
      }
    }

    // colisión nave-enemigo
    for(let e of enemies){
      if(Math.abs(e.x-ship.x)<20&&Math.abs(e.y-ship.y)<20){
        pushExplosion(ship.x,ship.y);running=false;showGameOver();return;
      }
    }

    spawnAcc+=dt;
    if(spawnAcc>0.15){if(Math.random()<dt*enemySpawnRate)spawnEnemy();spawnAcc=0;}

    lastShot+=dt;
    if(lastShot>=1/autoShootRate){lastShot=0;shoot();}
  }

  function render(dt){
    drawStars(dt);
    drawBullets();drawEnemies();drawShip();drawExplosions(dt);
    ctx.fillStyle="cyan";ctx.font="bold 14px monospace";ctx.fillText("PUNTAJE "+score,8,20);
  }

  function loop(ts){rafId=requestAnimationFrame(loop);
    if(!lastTs)lastTs=ts;let dt=(ts-lastTs)/1000;lastTs=ts;
    if(!running){render(dt);return;}
    update(dt);render(dt);}

  // UI
  function showGameOver(){document.getElementById("gameOver").style.display="block";}
  function hideGameOver(){document.getElementById("gameOver").style.display="none";}

  // API pública
  window.Game={
    start(){if(running)return;running=true;lastTs=0;hideGameOver();if(!rafId)rafId=requestAnimationFrame(loop);},
    stop(){running=false;},
    togglePause(){running=!running;if(running&&!rafId)rafId=requestAnimationFrame(loop);},
    restart(){resetGame();running=true;lastTs=0;hideGameOver();if(!rafId)rafId=requestAnimationFrame(loop);},
    handleWheel(d){ship.y+=d*10;ship.y=clamp(ship.y,ship.h/2,H-ship.h/2);},
    startCountdown(){
      const el=document.getElementById("gameCountdown");
      resetGame();hideGameOver();
      el.style.display="block";
      let c=3;el.textContent=c;
      const t=setInterval(()=>{
        c--;if(c>=1)el.textContent=c;
        if(c<0){clearInterval(t);el.style.display="none";window.Game.start();}
      },1000);
    }
  };

  document.getElementById("gameRestart").onclick=()=>window.Game.restart();
  document.getElementById("gamePause").onclick=()=>window.Game.togglePause();

  resetGame();if(!rafId)rafId=requestAnimationFrame(loop);
})();


/* ===== Control adicional: al entrar/salir de la página juegos ===== */
window.addEventListener('visibilitychange', ()=> {
  if(document.hidden && window.Game && window.Game.running) window.Game.stop();
});

/* ===== Botón físico OK también controla juego (ya definido arriba) ===== */
/* Fin del script */
</script>
</body>
</html>
